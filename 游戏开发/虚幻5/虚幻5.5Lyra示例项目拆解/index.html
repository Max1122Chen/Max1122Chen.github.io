
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Max1122Chen">
      
      
      
        <link rel="prev" href="../%E8%99%9A%E5%B9%BB4.27ARPG%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/">
      
      
        <link rel="next" href="../%E8%99%9A%E5%B9%BB5.5%E5%8E%9F%E7%94%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>虚幻5.5Lyra示例项目拆解 - Max1122Chen's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#55lyra" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Max1122Chen&#39;s Blog" class="md-header__button md-logo" aria-label="Max1122Chen's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Max1122Chen's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              虚幻5.5Lyra示例项目拆解
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Max1122Chen/Max1122Chen.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Max1122Chen.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Max1122Chen&#39;s Blog" class="md-nav__button md-logo" aria-label="Max1122Chen's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Max1122Chen's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Max1122Chen/Max1122Chen.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Max1122Chen.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    这是Max1122Chen的个人网站
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    游戏开发
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            游戏开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Unity
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Unity
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Unity/RPG%20Core%20Combat%20Creator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RPG Core Combat Creator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Unity/Unity%20RPG%20%E6%95%99%E7%A8%8B%E8%B7%9F%E5%AD%A6%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unity RPG 教程跟学笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Unity/Unity%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unity基础
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    游戏开发编程基础
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            游戏开发编程基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/%E4%B8%BA%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1Part%20I/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    为游戏开发学习程序设计Part I
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/%E4%B8%BA%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1Part%20II/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    为游戏开发学习程序设计Part II
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    游戏设计艺术
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            游戏设计艺术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_1" >
        
          
          <label class="md-nav__link" for="__nav_2_3_1" id="__nav_2_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Idea
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_1">
            <span class="md-nav__icon md-icon"></span>
            Idea
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/Idea/The%20Magic%20of%20Delicacy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Magic of Delicacy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/Idea/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E7%A7%91%E6%8A%80%E6%A0%91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏开发科技树
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/Idea/%E6%B8%B8%E6%88%8F%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏机制
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/Idea/%E6%B8%B8%E6%88%8F%E8%84%9A%E6%9C%AC%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88001/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏脚本设计方案001
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/Idea/%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E5%88%9B%E6%84%8F%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏设计创意练习
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" >
        
          
          <label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    像素艺术
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            像素艺术
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/%E5%83%8F%E7%B4%A0%E8%89%BA%E6%9C%AF/%E5%83%8F%E7%B4%A0%E8%89%BA%E6%9C%AF%E4%B9%8B%E7%AD%89%E8%B7%9D%E7%93%A6%E7%89%87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    像素艺术之等距视图
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/%E5%83%8F%E7%B4%A0%E8%89%BA%E6%9C%AF/%E6%B8%B8%E6%88%8F%E5%83%8F%E7%B4%A0%E8%89%BA%E6%9C%AF%E5%88%9B%E4%BD%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏像素艺术创作
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3_3" id="__nav_2_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    分析
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_3">
            <span class="md-nav__icon md-icon"></span>
            分析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B8%B8%E6%88%8F%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF/%E5%88%86%E6%9E%90/%E6%B8%B8%E6%88%8F%E5%BE%AA%E7%8E%AF%E8%AE%BE%E8%AE%A1Chapter01-Overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏循环设计Chapter01-Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    现代游戏引擎
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            现代游戏引擎
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1" >
        
          
          <label class="md-nav__link" for="__nav_2_4_1" id="__nav_2_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    GAMES104
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            GAMES104
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/00%20%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E5%AF%BC%E8%AE%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏引擎导论
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/01%20%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84%E5%88%86%E5%B1%82/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 引擎架构分层
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/02%20%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E6%B8%B8%E6%88%8F%E4%B8%96%E7%95%8C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 如何构建游戏世界
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/%E5%BC%95%E6%93%8E%E5%B7%A5%E5%85%B7%E9%93%BE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    引擎工具链
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8EGameplay%E7%8E%A9%E6%B3%95%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    游戏引擎Gameplay玩法基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E6%B8%B2%E6%9F%93%E5%AE%9E%E8%B7%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 游戏引擎的渲染实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E7%8E%B0%E4%BB%A3%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/GAMES104/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    网络游戏架构基础
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    虚幻5
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            虚幻5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ALS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ALS学习笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../InventorySystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    InventorySystem
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BD%BF%E7%94%A8UE%E5%BC%80%E5%8F%91%E6%B8%B8%E6%88%8F%E5%89%8D%E7%BD%AE%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    使用UE开发游戏前置软件安装
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB2D%E6%B8%B8%E6%88%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻2D游戏
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB4.27ARPG%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻4.27ARPG示例项目拆解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    虚幻5.5Lyra示例项目拆解
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    虚幻5.5Lyra示例项目拆解
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#part-i" class="md-nav__link">
    <span class="md-ellipsis">
      PART I 物品、物品栏、装备系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-lyrainventory" class="md-nav__link">
    <span class="md-ellipsis">
      1. LyraInventory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. LyraInventory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-inventorymanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InventoryManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 InventoryManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-entry" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 Entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-inventorylist" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 InventoryList
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.2 InventoryList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      Entry维护的ItemInstance的数量改变
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addentry" class="md-nav__link">
    <span class="md-ellipsis">
      AddEntry的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeentry" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveEntry的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getallitems" class="md-nav__link">
    <span class="md-ellipsis">
      GetAllItems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-inventorymanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 InventoryManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.3 InventoryManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canadditemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      几乎完全没做的CanAddItemDefinition……
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additemdefinitionadditeminstance" class="md-nav__link">
    <span class="md-ellipsis">
      AddItemDefinition和实际上没用的AddItemInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeitemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveItemDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consumeitemsbydefinition" class="md-nav__link">
    <span class="md-ellipsis">
      ConsumeItemsByDefinition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-lyrainventoryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 LyraInventoryItemInstance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 LyraInventoryItemInstance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-lyrainventoryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 LyraInventoryItemInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-gameplaytagstack" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 GameplayTagStack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2.2 GameplayTagStack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#addstack" class="md-nav__link">
    <span class="md-ellipsis">
      AddStack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removestack" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveStack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-lyraitemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 LyraItemDefinition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2.3 LyraItemDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fragment" class="md-nav__link">
    <span class="md-ellipsis">
      Fragment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pickuppable" class="md-nav__link">
    <span class="md-ellipsis">
      Pickuppable
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lyraequipment" class="md-nav__link">
    <span class="md-ellipsis">
      2. LyraEquipment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. LyraEquipment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-equipmentmanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 EquipmentManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 EquipmentManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-entryequipmentinstanceequipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 Entry与EquipmentInstance和EquipmentDefinition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1.1 Entry与EquipmentInstance和EquipmentDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equipmentinstance" class="md-nav__link">
    <span class="md-ellipsis">
      EquipmentInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      EquipmentDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addentry_1" class="md-nav__link">
    <span class="md-ellipsis">
      AddEntry的实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AddEntry的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abilitysetgivetoabilitysystem" class="md-nav__link">
    <span class="md-ellipsis">
      AbilitySet的GiveToAbilitySystem的实现：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeentry_1" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveEntry的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-equipmentlist" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 EquipmentList
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#213-equipmentmanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.3 EquipmentManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1.3 EquipmentManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equipitemunequipitem" class="md-nav__link">
    <span class="md-ellipsis">
      EquipItem和UnequipItem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-lyraquickbarcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      3. LyraQuickBarComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. LyraQuickBarComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-quickbarcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 QuickBarComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 QuickBarComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-quickbarslot" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 QuickBarSlot 的选择
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-ii-gameplayabilitysystem" class="md-nav__link">
    <span class="md-ellipsis">
      PART II GameplayAbilitySystem
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART II GameplayAbilitySystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-attributeset" class="md-nav__link">
    <span class="md-ellipsis">
      1. AttributeSet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. AttributeSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-lyraattributesetlyraattributeset" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 LyraAttributeSet——Lyra中的AttributeSet的基类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-heathset" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 HeathSet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 HeathSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pregameplayeffectexcute" class="md-nav__link">
    <span class="md-ellipsis">
      PreGameplayEffectExcute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgameplayeffectexcute" class="md-nav__link">
    <span class="md-ellipsis">
      PostGameplayEffectExcute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#121-healthcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 HealthComponent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-combatset" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 CombatSet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-iii-lyrainput" class="md-nav__link">
    <span class="md-ellipsis">
      PART III LyraInput系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART III LyraInput系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-inputconfig" class="md-nav__link">
    <span class="md-ellipsis">
      1. InputConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. InputConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-inputconfiglyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InputConfig和LyraPawnData
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 InputConfig和LyraPawnData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-lyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 LyraPawnData的起源
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-lyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 LyraPawnData如何发挥作用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-inputconfig" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 InputConfig的目的地
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-abilitysetinputtag" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 AbilitySet和InputTag的关联
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 AbilitySet和InputTag的关联">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-inputtaggameplayability" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 InputTag与GameplayAbility的绑定之处
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-abilityset" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 细探AbilitySet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 细探AbilitySet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131-abilitysetequipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1 AbilitySet与EquipmentDefinition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-iv-lyrainteraction" class="md-nav__link">
    <span class="md-ellipsis">
      PART IV LyraInteraction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART IV LyraInteraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-iinteractabletarget" class="md-nav__link">
    <span class="md-ellipsis">
      1. IInteractableTarget
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. IInteractableTarget">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-interactionoptionbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InteractionOptionBuilder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-interactionoption" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 InteractionOption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-gameplayability_interact" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 GameplayAbility_Interact
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 GameplayAbility_Interact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abilitytask_grantnearbyinteraction" class="md-nav__link">
    <span class="md-ellipsis">
      AbilityTask_GrantNearbyInteraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5.5%E5%8E%9F%E7%94%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻原生源码分析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5CropOut%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE%E6%8B%86%E8%A7%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5CropOut示例项目拆解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5GAS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5GAS(GameplayAbilitySystem)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5%E5%85%B3%E5%8D%A1%E7%99%BD%E7%9B%92%E6%90%AD%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5关卡白盒搭建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5%E5%8A%A8%E7%94%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5骨骼网格体动画系统
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5%E5%A2%9E%E5%BC%BA%E8%BE%93%E5%85%A5%E6%98%A0%E5%B0%84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5增强输入
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB5%E6%9D%90%E8%B4%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻5材质
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BBAI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻AI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BBGAS%E8%AF%BE%E7%A8%8B%E8%B7%9F%E5%AD%A6%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻GAS课程跟学笔记（UE开发最佳实践）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BBGamplay%E6%A1%86%E6%9E%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻Gamplay框架
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BBUI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E4%B8%8EC%2B%2B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻与C++
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E5%99%A8%E5%92%8C%E6%8E%A5%E5%8F%A3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻接口和委托
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E5%85%B3%E5%8D%A1%E5%BA%8F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻关卡序列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E5%9C%BA%E6%99%AF%E6%90%AD%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻场景搭建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E5%9F%BA%E6%9C%AC%E8%A6%81%E7%B4%A0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻基本要素
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻学习心得
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E5%BC%80%E5%8F%91%E7%AD%96%E7%95%A5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻开发策略
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E6%B8%B8%E6%88%8F%E5%AD%98%E6%A1%A3%E6%96%B9%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻游戏存档方式
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E5%B9%BB%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虚幻设计模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    计算机图形学
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            计算机图形学
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Make%20a%20Software%20Renderer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Make a Software Renderer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_2" >
        
          
          <label class="md-nav__link" for="__nav_2_6_2" id="__nav_2_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    GAMES101
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_2">
            <span class="md-nav__icon md-icon"></span>
            GAMES101
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Advanced%20Topics%20in%20Rendering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Topics in Rendering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Animation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Animation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Cameras%2C%20Lense%20%26%20Light%20Fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cameras, Lense & Light Fields
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Color%20and%20Perception/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Color and Perception
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/GAMES101%E4%BD%9C%E4%B8%9A%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GAMES101 作业笔记
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Geometry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Geometry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Materials%20and%20Apperance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Material and Appearance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Rasterization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rasterization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Ray%20Tracing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ray Tracing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Shading%20%26%20Texture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shading &amp; Texture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Transform/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Transform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/Viewing%20Transformations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Viewing Transformations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GAMES101/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    线性代数
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_3" >
        
          
          <label class="md-nav__link" for="__nav_2_6_3" id="__nav_2_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    GraphicsAPI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_3">
            <span class="md-nav__icon md-icon"></span>
            GraphicsAPI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/GraphicsAPI/OpenGL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenGL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#part-i" class="md-nav__link">
    <span class="md-ellipsis">
      PART I 物品、物品栏、装备系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-lyrainventory" class="md-nav__link">
    <span class="md-ellipsis">
      1. LyraInventory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. LyraInventory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-inventorymanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InventoryManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 InventoryManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-entry" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 Entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-inventorylist" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 InventoryList
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.2 InventoryList">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      Entry维护的ItemInstance的数量改变
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addentry" class="md-nav__link">
    <span class="md-ellipsis">
      AddEntry的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeentry" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveEntry的实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getallitems" class="md-nav__link">
    <span class="md-ellipsis">
      GetAllItems
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-inventorymanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 InventoryManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1.3 InventoryManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canadditemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      几乎完全没做的CanAddItemDefinition……
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additemdefinitionadditeminstance" class="md-nav__link">
    <span class="md-ellipsis">
      AddItemDefinition和实际上没用的AddItemInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeitemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveItemDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consumeitemsbydefinition" class="md-nav__link">
    <span class="md-ellipsis">
      ConsumeItemsByDefinition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-lyrainventoryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 LyraInventoryItemInstance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 LyraInventoryItemInstance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-lyrainventoryiteminstance" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 LyraInventoryItemInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-gameplaytagstack" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 GameplayTagStack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2.2 GameplayTagStack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#addstack" class="md-nav__link">
    <span class="md-ellipsis">
      AddStack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removestack" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveStack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-lyraitemdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 LyraItemDefinition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2.3 LyraItemDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fragment" class="md-nav__link">
    <span class="md-ellipsis">
      Fragment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pickuppable" class="md-nav__link">
    <span class="md-ellipsis">
      Pickuppable
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lyraequipment" class="md-nav__link">
    <span class="md-ellipsis">
      2. LyraEquipment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. LyraEquipment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-equipmentmanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 EquipmentManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 EquipmentManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-entryequipmentinstanceequipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 Entry与EquipmentInstance和EquipmentDefinition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1.1 Entry与EquipmentInstance和EquipmentDefinition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equipmentinstance" class="md-nav__link">
    <span class="md-ellipsis">
      EquipmentInstance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      EquipmentDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addentry_1" class="md-nav__link">
    <span class="md-ellipsis">
      AddEntry的实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AddEntry的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abilitysetgivetoabilitysystem" class="md-nav__link">
    <span class="md-ellipsis">
      AbilitySet的GiveToAbilitySystem的实现：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeentry_1" class="md-nav__link">
    <span class="md-ellipsis">
      RemoveEntry的实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-equipmentlist" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 EquipmentList
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#213-equipmentmanagercomponent" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.3 EquipmentManagerComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1.3 EquipmentManagerComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equipitemunequipitem" class="md-nav__link">
    <span class="md-ellipsis">
      EquipItem和UnequipItem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-lyraquickbarcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      3. LyraQuickBarComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. LyraQuickBarComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-quickbarcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 QuickBarComponent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 QuickBarComponent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-quickbarslot" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 QuickBarSlot 的选择
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-ii-gameplayabilitysystem" class="md-nav__link">
    <span class="md-ellipsis">
      PART II GameplayAbilitySystem
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART II GameplayAbilitySystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-attributeset" class="md-nav__link">
    <span class="md-ellipsis">
      1. AttributeSet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. AttributeSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-lyraattributesetlyraattributeset" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 LyraAttributeSet——Lyra中的AttributeSet的基类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-heathset" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 HeathSet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 HeathSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pregameplayeffectexcute" class="md-nav__link">
    <span class="md-ellipsis">
      PreGameplayEffectExcute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgameplayeffectexcute" class="md-nav__link">
    <span class="md-ellipsis">
      PostGameplayEffectExcute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#121-healthcomponent" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 HealthComponent
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-combatset" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 CombatSet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-iii-lyrainput" class="md-nav__link">
    <span class="md-ellipsis">
      PART III LyraInput系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART III LyraInput系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-inputconfig" class="md-nav__link">
    <span class="md-ellipsis">
      1. InputConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. InputConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-inputconfiglyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InputConfig和LyraPawnData
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 InputConfig和LyraPawnData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-lyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 LyraPawnData的起源
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-lyrapawndata" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 LyraPawnData如何发挥作用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-inputconfig" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 InputConfig的目的地
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-abilitysetinputtag" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 AbilitySet和InputTag的关联
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 AbilitySet和InputTag的关联">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-inputtaggameplayability" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 InputTag与GameplayAbility的绑定之处
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-abilityset" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 细探AbilitySet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 细探AbilitySet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#131-abilitysetequipmentdefinition" class="md-nav__link">
    <span class="md-ellipsis">
      1.3.1 AbilitySet与EquipmentDefinition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-iv-lyrainteraction" class="md-nav__link">
    <span class="md-ellipsis">
      PART IV LyraInteraction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PART IV LyraInteraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-iinteractabletarget" class="md-nav__link">
    <span class="md-ellipsis">
      1. IInteractableTarget
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. IInteractableTarget">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-interactionoptionbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 InteractionOptionBuilder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-interactionoption" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 InteractionOption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-gameplayability_interact" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 GameplayAbility_Interact
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 GameplayAbility_Interact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abilitytask_grantnearbyinteraction" class="md-nav__link">
    <span class="md-ellipsis">
      AbilityTask_GrantNearbyInteraction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="55lyra">虚幻5.5Lyra示例项目拆解</h1>
<h2 id="part-i">PART I 物品、物品栏、装备系统</h2>
<h2 id="1-lyrainventory">1. LyraInventory</h2>
<h3 id="11-inventorymanagercomponent">1.1 InventoryManagerComponent</h3>
<p>​   Lyra项目中定义了一个InventoryManagerComponent来专门管理和Inventory相关的事宜。</p>
<p>​   InventoryManagerComponent由LyraPlayerController拥有，但是我死是找不到在LyraPlayerController的哪定义的InventoryManagerComponent？？？ </p>
<blockquote>
<p>[!NOTE]</p>
<p>​ 解决了，原来是在GameFeature激活时才进行挂载在LyraPlayerController上。</p>
</blockquote>
<p>InventoryManagerComponent.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Components/ActorComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Net/Serialization/FastArraySerializer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInventoryManagerComponent.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemDefinition</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemInstance</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryManagerComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryList</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FNetDeltaSerializeInfo</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FReplicationFlags</span><span class="p">;</span>

<span class="cm">/** A message when an item is added to the inventory */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryChangeMessage</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="c1">//@TODO: Tag based names+owning actors for inventories instead of directly exposing the component?</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UActorComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InventoryOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">NewCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">Delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/** A single entry in an inventory */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryEntry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraInventoryEntry</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FLyraInventoryList</span><span class="p">;</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/** List of inventory items */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializer</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="p">()</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="p">(</span><span class="n">UActorComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetAllItems</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">//~FFastArraySerializer contract</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//~End of FFastArraySerializer contract</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">NetDeltaSerialize</span><span class="p">(</span><span class="n">FNetDeltaSerializeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FFastArraySerializer</span><span class="o">::</span><span class="n">FastArrayDeltaSerialize</span><span class="o">&lt;</span><span class="n">FLyraInventoryEntry</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraInventoryList</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Entries</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemClass</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RemoveEntry</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">BroadcastChangeMessage</span><span class="p">(</span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">OldCount</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NewCount</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Replicated list of items</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraInventoryEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Entries</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UActorComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TStructOpsTypeTraits</span><span class="o">&lt;</span><span class="n">FLyraInventoryList</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TStructOpsTypeTraitsBase2</span><span class="o">&lt;</span><span class="n">FLyraInventoryList</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">WithNetDeltaSerializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">};</span>










<span class="cm">/**</span>
<span class="cm"> * Manages an inventory</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UActorComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanAddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">AddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RemoveItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetAllItems</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">FindFirstItemStackByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="nf">GetTotalItemCountByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ConsumeItemsByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NumToConsume</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ReplicateSubobjects</span><span class="p">(</span><span class="k">class</span><span class="w"> </span><span class="nc">UActorChannel</span><span class="o">*</span><span class="w"> </span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FOutBunch</span><span class="o">*</span><span class="w"> </span><span class="n">Bunch</span><span class="p">,</span><span class="w"> </span><span class="n">FReplicationFlags</span><span class="o">*</span><span class="w"> </span><span class="n">RepFlags</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="w"> </span><span class="n">InventoryList</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   Lyra的Inventory主要有这两个概念：<strong>Entry</strong>和<strong>InventoryList</strong>。</p>
<h4 id="111-entry">1.1.1 Entry</h4>
<p>​   Entry，在此语境中可翻译成“条目”“账目”比较适合。</p>
<p>​   Entry就类似于物品栏中的一个<strong>格子</strong>。</p>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** A single entry in an inventory */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryEntry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraInventoryEntry</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FLyraInventoryList</span><span class="p">;</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   可以看到，一个Inventory中的“Entry”主要维护的成员是一个<strong>ItemInstance</strong>和一个<strong>StackCount</strong>。</p>
<h4 id="112-inventorylist">1.1.2 InventoryList</h4>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** List of inventory items */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializer</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="p">()</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="p">(</span><span class="n">UActorComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetAllItems</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">//~FFastArraySerializer contract</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//~End of FFastArraySerializer contract</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">NetDeltaSerialize</span><span class="p">(</span><span class="n">FNetDeltaSerializeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FFastArraySerializer</span><span class="o">::</span><span class="n">FastArrayDeltaSerialize</span><span class="o">&lt;</span><span class="n">FLyraInventoryEntry</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraInventoryList</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Entries</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemClass</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RemoveEntry</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">BroadcastChangeMessage</span><span class="p">(</span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">OldCount</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NewCount</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Replicated list of items</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraInventoryEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Entries</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UActorComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   InventoryList主要就是维护了一个FLyraInventoryEntry的<strong>数组</strong>，并且还定义了一下List中<strong>Entry</strong>的增删的函数:AddEntry和RemoveEntry，这两个函数可以初始化新的Entry，并将其加入到List中去，还有一条Entry变动的委托。</p>
<h5 id="entryiteminstance">Entry维护的ItemInstance的数量改变</h5>
<p>​   对于Entry内维护的ItemInstance的数量的改变，由以下三个函数完成：</p>
<p><img alt="image-20250128212450369" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250128212450369.png" /></p>
<p>​   它们的实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// FLyraInventoryList</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraInventoryList::PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">Index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">[</span><span class="n">Index</span><span class="p">];</span>
<span class="w">       </span><span class="n">BroadcastChangeMessage</span><span class="p">(</span><span class="n">Stack</span><span class="p">,</span><span class="w"> </span><span class="cm">/*OldCount=*/</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NewCount=*/</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">       </span><span class="n">Stack</span><span class="p">.</span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraInventoryList::PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">Index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">[</span><span class="n">Index</span><span class="p">];</span>
<span class="w">       </span><span class="n">BroadcastChangeMessage</span><span class="p">(</span><span class="n">Stack</span><span class="p">,</span><span class="w"> </span><span class="cm">/*OldCount=*/</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NewCount=*/</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">       </span><span class="n">Stack</span><span class="p">.</span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraInventoryList::PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">Index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">[</span><span class="n">Index</span><span class="p">];</span>
<span class="w">       </span><span class="n">check</span><span class="p">(</span><span class="n">Stack</span><span class="p">.</span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">);</span>
<span class="w">       </span><span class="n">BroadcastChangeMessage</span><span class="p">(</span><span class="n">Stack</span><span class="p">,</span><span class="w"> </span><span class="cm">/*OldCount=*/</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">LastObservedCount</span><span class="p">,</span><span class="w"> </span><span class="cm">/*NewCount=*/</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">       </span><span class="n">Stack</span><span class="p">.</span><span class="n">LastObservedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="addentry"><strong>AddEntry的实现</strong></h5>
<div class="highlight"><pre><span></span><code><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">FLyraInventoryList::AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">ItemDef</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="p">);</span>

<span class="w">    </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">OwningActor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">();</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwningActor</span><span class="o">-&gt;</span><span class="n">HasAuthority</span><span class="p">());</span>


<span class="w">    </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">.</span><span class="n">AddDefaulted_GetRef</span><span class="p">();</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">());</span><span class="w">  </span><span class="c1">//@TODO: Using the actor instead of component as the outer due to UE-127172</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">SetItemDef</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">Fragment</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GetDefault</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Fragments</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Fragment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">Fragment</span><span class="o">-&gt;</span><span class="n">OnInstanceCreated</span><span class="p">(</span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StackCount</span><span class="p">;</span>
<span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//const ULyraInventoryItemDefinition* ItemCDO = GetDefault&lt;ULyraInventoryItemDefinition&gt;(ItemDef);</span>
<span class="w">    </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">NewEntry</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   值得注意这里对Entries（TArray）添加元素所调用的方法，是创建了一个新的Default的实例并且拿到它的引用，这样可以进一步配置它。</p>
<h5 id="removeentry">RemoveEntry的实现</h5>
<p>​   注意的点是用了一下迭代器+循环遍历，这里不能直接for Instance应该是因为数组不能去遍历出Entry的内部成员，但是为什么不直接for Entry？？？不可以嘛?<strong>还是因为不用迭代器不能调用RemoveCurrent？</strong>应该是这样，需要用迭代器去删除遍历到的目标。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">FLyraInventoryList::RemoveEntry</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">EntryIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">.</span><span class="n">CreateIterator</span><span class="p">();</span><span class="w"> </span><span class="n">EntryIt</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">EntryIt</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">EntryIt</span><span class="p">;</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">EntryIt</span><span class="p">.</span><span class="n">RemoveCurrent</span><span class="p">();</span>
<span class="w">          </span><span class="n">MarkArrayDirty</span><span class="p">();</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="getallitems">GetAllItems</h5>
<p>此外InventoryList还有一个GetAllItems用来获得包含所有Instance的一个数组</p>
<div class="highlight"><pre><span></span><code><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">FLyraInventoryList</span><span class="o">::</span><span class="n">GetAllItems</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">Results</span><span class="p">;</span>
<span class="w">    </span><span class="n">Results</span><span class="p">.</span><span class="n">Reserve</span><span class="p">(</span><span class="n">Entries</span><span class="p">.</span><span class="n">Num</span><span class="p">());</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Entries</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="c1">//@TODO: Would prefer to not deal with this here and hide it further?</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">Results</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Results</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   Reserve是用来开辟空间的。</p>
<h4 id="113-inventorymanagercomponent">1.1.3 InventoryManagerComponent</h4>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Manages an inventory</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UActorComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraInventoryManagerComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">CanAddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">AddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RemoveItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetAllItems</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">FindFirstItemStackByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="nf">GetTotalItemCountByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ConsumeItemsByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NumToConsume</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ReplicateSubobjects</span><span class="p">(</span><span class="k">class</span><span class="w"> </span><span class="nc">UActorChannel</span><span class="o">*</span><span class="w"> </span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FOutBunch</span><span class="o">*</span><span class="w"> </span><span class="n">Bunch</span><span class="p">,</span><span class="w"> </span><span class="n">FReplicationFlags</span><span class="o">*</span><span class="w"> </span><span class="n">RepFlags</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraInventoryList</span><span class="w"> </span><span class="n">InventoryList</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h5 id="canadditemdefinition">几乎完全没做的CanAddItemDefinition……</h5>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::CanAddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//@TODO: Add support for stack limit / uniqueness checks / etc...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="additemdefinitionadditeminstance">AddItemDefinition和实际上没用的AddItemInstance</h5>
<p>​   AddItemDefinition本质的功能就是调用了一下InventoryList的AddEntry，RemoveItemDefinition同理。</p>
<div class="highlight"><pre><span></span><code><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::AddItemDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ItemDef</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsUsingRegisteredSubObjectList</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IsReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Result</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">AddReplicatedSubObject</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::AddItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//这个AddEntry没有实现，所以这个函数屁用没有</span>
<span class="w">    </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsUsingRegisteredSubObjectList</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IsReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">AddReplicatedSubObject</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="removeitemdefinition">RemoveItemDefinition</h5>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::RemoveItemInstance</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">RemoveEntry</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ItemInstance</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IsUsingRegisteredSubObjectList</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">RemoveReplicatedSubObject</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   这两个没太多说的。</p>
<div class="highlight"><pre><span></span><code><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::FindFirstItemStackByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">Entries</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsValid</span><span class="p">(</span><span class="n">Instance</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">GetItemDef</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">Instance</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">int32</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::GetTotalItemCountByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">TotalCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FLyraInventoryEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">Entries</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsValid</span><span class="p">(</span><span class="n">Instance</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">GetItemDef</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="o">++</span><span class="n">TotalCount</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TotalCount</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="consumeitemsbydefinition">ConsumeItemsByDefinition</h5>
<p>​   Lyra的物品栏的消耗逻辑比较特别，由于Lyra是一个射击游戏，它好像是不太在乎物品栏的物品的“槽位”的概念的，事实上好像确实是这样。从这里可以看出LyraInventory每次获得了物品，视作为新增了一个“Entry”，类似于一个进账记录，每条记录会记录一下这条进账获得了多少某个品类的东西。这也可以说明为什么LyraInventory选择使用TArray而不是Map，因为Lyra不关心“槽位”的概念，Lyra只关心“有什么”和“有多少”的概念。因此Lyra中消耗某种Item的方式是遍历List，在完成目标消耗指标之前一直去“消耗”遇到的Entry。</p>
<p>​   要注意的是，这里的消耗Entry是消耗整个Entry包含的Item，而不是消耗Item中的几个，例如一条Entry中维护了“子弹”*50，ConsumeItem就会直接把这整条Entry消耗掉而不是消耗50发弹药中的若干发。</p>
<p>​   Item的实际数量由ItemInstance中的StatTag维护，所以Item的实际数量的增删的逻辑在ItemInstance中，我们接下来就去看ItemInstance。</p>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">ULyraInventoryManagerComponent::ConsumeItemsByDefinition</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NumToConsume</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">OwningActor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetOwner</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OwningActor</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">OwningActor</span><span class="o">-&gt;</span><span class="n">HasAuthority</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//@TODO: N squared right now as there&#39;s no acceleration structure</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">TotalConsumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">TotalConsumed</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NumToConsume</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraInventoryManagerComponent</span><span class="o">::</span><span class="n">FindFirstItemStackByDefinition</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">InventoryList</span><span class="p">.</span><span class="n">RemoveEntry</span><span class="p">(</span><span class="n">Instance</span><span class="p">);</span>
<span class="w">          </span><span class="o">++</span><span class="n">TotalConsumed</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">       </span><span class="k">else</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TotalConsumed</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NumToConsume</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="12-lyrainventoryiteminstance">1.2 LyraInventoryItemInstance</h3>
<h4 id="121-lyrainventoryiteminstance">1.2.1 LyraInventoryItemInstance</h4>
<p>LyraInventoryItemInstance.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;System/GameplayTagStack.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Templates/SubclassOf.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInventoryItemInstance.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FLifetimeProperty</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemDefinition</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemFragment</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayTag</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ULyraInventoryItemInstance</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemInstance</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsSupportedForNetworking</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="w">    </span><span class="c1">// Adds a specified number of stacks to the tag (does nothing if StackCount is below 1)</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddStatTagStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Removes a specified number of stacks from the tag (does nothing if StackCount is below 1)</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="w"> </span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RemoveStatTagStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Returns the stack count of the specified tag (or 0 if the tag is not present)</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">GetStatTagStackCount</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Returns true if there is at least one stack of the specified tag</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">HasStatTag</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetItemDef</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">DeterminesOutputType</span><span class="o">=</span><span class="n">FragmentClass</span><span class="p">))</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ResultClass</span><span class="o">&gt;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ResultClass</span><span class="o">*</span><span class="w"> </span><span class="n">FindFragmentByClass</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">ResultClass</span><span class="o">*</span><span class="p">)</span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">ResultClass</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="cp">#if UE_WITH_IRIS</span>
<span class="w">    </span><span class="cm">/** Register all replication fragments */</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">RegisterReplicationFragments</span><span class="p">(</span><span class="n">UE</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">FFragmentRegistrationContext</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">UE</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">EFragmentRegistrationFlags</span><span class="w"> </span><span class="n">RegistrationFlags</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="cp">#endif </span><span class="c1">// UE_WITH_IRIS</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetItemDef</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InDef</span><span class="p">);</span>

<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInventoryList</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FGameplayTagStackContainer</span><span class="w"> </span><span class="n">StatTags</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The item definition</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   ItemInstance实际上主要维护了一个ItemDefinition和一个StatTags（FGameplayTagStackContainer），基本上ItemInstance的StatCount的增减都是通过FGameplayTagStackContainer的方法。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInventoryItemInstance.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Inventory/LyraInventoryItemDefinition.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Net/UnrealNetwork.h&quot;</span>

<span class="cp">#if UE_WITH_IRIS</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Iris/ReplicationSystem/ReplicationFragmentUtil.h&quot;</span>
<span class="cp">#endif </span><span class="c1">// UE_WITH_IRIS</span>

<span class="cp">#include UE_INLINE_GENERATED_CPP_BY_NAME(LyraInventoryItemInstance)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FLifetimeProperty</span><span class="p">;</span>

<span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">ULyraInventoryItemInstance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLifetimeProperty</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">OutLifetimeProps</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>

<span class="w">    </span><span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">ThisClass</span><span class="p">,</span><span class="w"> </span><span class="n">StatTags</span><span class="p">);</span>
<span class="w">    </span><span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">ThisClass</span><span class="p">,</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if UE_WITH_IRIS</span>
<span class="kt">void</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">RegisterReplicationFragments</span><span class="p">(</span><span class="n">UE</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">FFragmentRegistrationContext</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">UE</span><span class="o">::</span><span class="n">Net</span><span class="o">::</span><span class="n">EFragmentRegistrationFlags</span><span class="w"> </span><span class="n">RegistrationFlags</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">UE</span><span class="o">::</span><span class="nn">Net</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Build descriptors and allocate PropertyReplicationFragments for this object</span>
<span class="w">    </span><span class="n">FReplicationFragmentUtil</span><span class="o">::</span><span class="n">CreateAndRegisterFragmentsForObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">RegistrationFlags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// UE_WITH_IRIS</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">AddStatTagStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StatTags</span><span class="p">.</span><span class="n">AddStack</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">RemoveStatTagStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">StatTags</span><span class="p">.</span><span class="n">RemoveStack</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int32</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">GetStatTagStackCount</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">StatTags</span><span class="p">.</span><span class="n">GetStackCount</span><span class="p">(</span><span class="n">Tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">HasStatTag</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">StatTags</span><span class="p">.</span><span class="n">ContainsTag</span><span class="p">(</span><span class="n">Tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">SetItemDef</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InDef</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ItemDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InDef</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">::</span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ItemDef</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">FragmentClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">GetDefault</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">FragmentClass</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   通过Rider的查看函数蓝图用法可以发现LyraItemInstance的StatTag的增删要么就是“换弹”要么就是“捡到补充弹药”，所以LyraItem其中一种就是“弹药”。</p>
<p>​   既然ItemInstance的数量是靠GameplayTagStack维护的，那么我们再来看一看它。</p>
<h4 id="122-gameplaytagstack">1.2.2 GameplayTagStack</h4>
<p>GameplayTagStack.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameplayTagContainer.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Net/Serialization/FastArraySerializer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameplayTagStack.generated.h&quot;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayTagStackContainer</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FNetDeltaSerializeInfo</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Represents one stack of a gameplay tag (tag + count)</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayTagStack</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FGameplayTagStack</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FGameplayTagStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InTag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">InStackCount</span><span class="p">)</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">Tag</span><span class="p">(</span><span class="n">InTag</span><span class="p">)</span>
<span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">(</span><span class="n">InStackCount</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FGameplayTagStackContainer</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/** Container of gameplay tag stacks */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayTagStackContainer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializer</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FGameplayTagStackContainer</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// : Owner(nullptr)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Adds a specified number of stacks to the tag (does nothing if StackCount is below 1)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Removes a specified number of stacks from the tag (does nothing if StackCount is below 1)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RemoveStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Returns the stack count of the specified tag (or 0 if the tag is not present)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="nf">GetStackCount</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">TagToCountMap</span><span class="p">.</span><span class="n">FindRef</span><span class="p">(</span><span class="n">Tag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Returns true if there is at least one stack of the specified tag</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ContainsTag</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">TagToCountMap</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">Tag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//~FFastArraySerializer contract</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//~End of FFastArraySerializer contract</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">NetDeltaSerialize</span><span class="p">(</span><span class="n">FNetDeltaSerializeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">FFastArraySerializer</span><span class="o">::</span><span class="n">FastArrayDeltaSerialize</span><span class="o">&lt;</span><span class="n">FGameplayTagStack</span><span class="p">,</span><span class="w"> </span><span class="n">FGameplayTagStackContainer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Stacks</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Replicated list of gameplay tag stacks</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FGameplayTagStack</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Stacks</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Accelerated list of tag stacks for queries</span>
<span class="w">    </span><span class="n">TMap</span><span class="o">&lt;</span><span class="n">FGameplayTag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TagToCountMap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TStructOpsTypeTraits</span><span class="o">&lt;</span><span class="n">FGameplayTagStackContainer</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TStructOpsTypeTraitsBase2</span><span class="o">&lt;</span><span class="n">FGameplayTagStackContainer</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">WithNetDeltaSerializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>​   一个GameplayTagStack是一个结构体，本质上维护了一个GameplayTag和一个StackCount（int32），</p>
<h5 id="addstack">AddStack</h5>
<div class="highlight"><pre><span></span><code><span class="c1">// FGameplayTagStackContainer</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FGameplayTagStackContainer::AddStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Tag</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FFrame</span><span class="o">::</span><span class="n">KismetExecutionMessage</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;An invalid tag was passed to AddStack&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">ELogVerbosity</span><span class="o">::</span><span class="n">Warning</span><span class="p">);</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StackCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">FGameplayTagStack</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Stacks</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stack</span><span class="p">.</span><span class="n">Tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">const</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NewCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">StackCount</span><span class="p">;</span>
<span class="w">             </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewCount</span><span class="p">;</span>
<span class="w">             </span><span class="n">TagToCountMap</span><span class="p">[</span><span class="n">Tag</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewCount</span><span class="p">;</span>
<span class="w">             </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">Stack</span><span class="p">);</span>
<span class="w">             </span><span class="k">return</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">FGameplayTagStack</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewStack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stacks</span><span class="p">.</span><span class="n">Emplace_GetRef</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">       </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">NewStack</span><span class="p">);</span>
<span class="w">       </span><span class="n">TagToCountMap</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">StackCount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   根据当前StackContainer中是否已有Stack来决定是新增一个Stack还是直接增加Stack的StackCount。</p>
<h5 id="removestack">RemoveStack</h5>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">FGameplayTagStackContainer::RemoveStack</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Tag</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FFrame</span><span class="o">::</span><span class="n">KismetExecutionMessage</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;An invalid tag was passed to RemoveStack&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">ELogVerbosity</span><span class="o">::</span><span class="n">Warning</span><span class="p">);</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//@TODO: Should we error if you try to remove a stack that doesn&#39;t exist or has a smaller count?</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StackCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stacks</span><span class="p">.</span><span class="n">CreateIterator</span><span class="p">();</span><span class="w"> </span><span class="n">It</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">It</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">FGameplayTagStack</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">It</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stack</span><span class="p">.</span><span class="n">Tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">StackCount</span><span class="p">)</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="n">It</span><span class="p">.</span><span class="n">RemoveCurrent</span><span class="p">();</span>
<span class="w">                </span><span class="n">TagToCountMap</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">Tag</span><span class="p">);</span>
<span class="w">                </span><span class="n">MarkArrayDirty</span><span class="p">();</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">             </span><span class="k">else</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">NewCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">StackCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">Stack</span><span class="p">.</span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">TagToCountMap</span><span class="p">[</span><span class="n">Tag</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">Stack</span><span class="p">);</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">             </span><span class="k">return</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   用迭代器估计是为了可以在遍历的时候动态删除。</p>
<p>​   貌似一个ItemInstance实际上可以允许有不同的Tag进入？那这个Item怎么保证单纯？</p>
<p>​   带着这个疑惑，我搜索了GameplayTagStack的用法，发现它不仅仅用在InventoryItemInstance中，还用在了PlayerState和Team中，说明这个东西是一物多用了，所以它带有的一些功能在ItemInstance中看起来格格不入，应该是服务于更泛用的场景。</p>
<p>​   所以ItemInctance应该算是借用了这个东西来计算Stack，因为这个东西继承了FFastArraySerializer，应该是方便网络复制相关的东西。</p>
<p>​   实际上一个ItemInstance在使用的过程中应该永远只会有一种Tag，TagtoCount这个Map实际上也只有一个元素。</p>
<blockquote>
<p>[!NOTE]</p>
<p>​ 后来我想通了一个很鸡贼的点，就是一个Item的Instance中的StackCount并不是代表其自己有多少，而是可以代表别的东西有多少，例如对于枪来说，就是有多少弹药，所以根本不会有实体的弹药Item出现在玩家的Inventory，而是弹药以Tag的形式出现在了ItemInstance的Stacks中。真正代表一个Item有多少的应该还是Entry中的StackCount，但是由于Lyra的进Inventory的Item基本上都是“武器”，所以都是不可堆叠的一个一个的，显得Entry的StackCount似乎作用不大。</p>
</blockquote>
<p>​   接下来再看InventoryItemDefinition。</p>
<h4 id="123-lyraitemdefinition">1.2.3 LyraItemDefinition</h4>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Kismet/BlueprintFunctionLibrary.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInventoryItemDefinition.generated.h&quot;</span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TSubclassOf</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemInstance</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>

<span class="c1">//////////////////////////////////////////////////////////////////////</span>

<span class="c1">// Represents a fragment of an item definition</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">DefaultToInstanced</span><span class="p">,</span><span class="w"> </span><span class="n">EditInlineNew</span><span class="p">,</span><span class="w"> </span><span class="n">Abstract</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OnInstanceCreated</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{}</span>
<span class="p">};</span>

<span class="c1">//////////////////////////////////////////////////////////////////////</span>

<span class="cm">/**</span>
<span class="cm"> * ULyraInventoryItemDefinition</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">,</span><span class="w"> </span><span class="n">Abstract</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemDefinition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraInventoryItemDefinition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Display</span><span class="p">)</span>
<span class="w">    </span><span class="n">FText</span><span class="w"> </span><span class="n">DisplayName</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Display</span><span class="p">,</span><span class="w"> </span><span class="n">Instanced</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Fragments</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">//@TODO: Make into a subsystem instead?</span>
<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryFunctionLibrary</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UBlueprintFunctionLibrary</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">DeterminesOutputType</span><span class="o">=</span><span class="n">FragmentClass</span><span class="p">))</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">FindItemDefinitionFragment</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>​   先直接看ItemDefinition内部。</p>
<p>​   首先ItemDefinition继承自UObject，出身比较简单。</p>
<p>​   ItemDefinition本身也相当简单，其中只维护了一个FText DisplayName和一个Fragment的TArray。</p>
<p>​   再结合Fragment本身来看，其本体相当简单，继承自UObject没有任何属性，只有一个没有实现方法OnInstanceCreated，由于给派生的子类去定义，Fragment本身只是起到一个父类继承的意义，其真正的东西都在自己的诸多子类中。</p>
<p>​   Definition相关的方法，主要就是去找Fragment。</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraInventoryItemDefinition::FindFragmentByClass</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FragmentClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="n">Fragment</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Fragments</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Fragment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Fragment</span><span class="o">-&gt;</span><span class="n">IsA</span><span class="p">(</span><span class="n">FragmentClass</span><span class="p">))</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">Fragment</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//////////////////////////////////////////////////////////////////////</span>
<span class="c1">// ULyraInventoryItemDefinition</span>

<span class="k">const</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraInventoryFunctionLibrary::FindItemDefinitionFragment</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">,</span><span class="w"> </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemFragment</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FragmentClass</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ItemDef</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">FragmentClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">GetDefault</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ItemDef</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindFragmentByClass</span><span class="p">(</span><span class="n">FragmentClass</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="fragment">Fragment</h5>
<p>​   可以说实际上ItemDefinition就是一堆Fragment的包装盒，真正有用的信息都在Fragment中，而定义一个ItemDefinition的时候，就可以<strong>选择性地</strong>给ItemDefinition添加需要的Fragment信息，例如装备图标、弹夹容量等等。</p>
<p>​   简单在Rider中查找一下Definition中的DisplayName的更改的地方，就能找到几个被定义好的ItemDefinition，例如这是“Pistol”的Definition，其中我们还可以看到EquipmentDefinition，待会我们再去看EquipmentDefinition和ItemDefinition的联系与差别。</p>
<p>​   可以看到，通过一个TArray<Fragment>加Fragment派生子类的组合拳，ItemDefinition实现了很灵活很清晰的物品信息配置。</p>
<p>​   暂时先不要去看其他的内容，不然就出不来了，我们目前只需知道ItemDefinition实现了很不错的效果即可。</p>
<p><img alt="image-20250129095655127" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129095655127.png" /></p>
<p>​   基本上Fragment的各个子类就是表明了各种物品可能有的信息，比较简单。</p>
<p>​   例如这是UInventoryFragment_EquippableItem的定义，注意到它没有重写OnInstanceCreated.</p>
<p>​   EquippableItem就是提供了一个ULyraEquipmentDefinition的信息。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentDefinition</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>

<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UInventoryFragment_EquippableItem</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Lyra</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   而SetStat中有重写OnInstanceCreated，可以见得它有更多的“功能”。</p>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemInstance</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayTag</span><span class="p">;</span>

<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UInventoryFragment_SetStats</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ULyraInventoryItemFragment</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">TMap</span><span class="o">&lt;</span><span class="n">FGameplayTag</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InitialItemStats</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OnInstanceCreated</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="nf">GetItemStatByTag</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</code></pre></div>
<p>.cpp</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">UInventoryFragment_SetStats::OnInstanceCreated</span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">KVP</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InitialItemStats</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">AddStatTagStack</span><span class="p">(</span><span class="n">KVP</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">KVP</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">int32</span><span class="w"> </span><span class="nf">UInventoryFragment_SetStats::GetItemStatByTag</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">Tag</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">int32</span><span class="o">*</span><span class="w"> </span><span class="n">StatPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InitialItemStats</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Tag</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="o">*</span><span class="n">StatPtr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   OnInstanceCreated方法提供了一个初始化Item中的弹药的方法。</p>
<p>​   而OnInstanceCreated方法在InventoryManagerComponent的AddEntry中被使用到：</p>
<p><img alt="image-20250129105033998" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129105033998.png" /></p>
<p>​   结合ID_Pistol的Stat可以了解其初始化的方法。</p>
<p><img alt="image-20250129105248364" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129105248364.png" /></p>
<p><img alt="image-20250129105201830" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129105201830.png" /></p>
<p>​   可以看出，SetStat实际上是通过了各种Tag配合一个整数，来实现了定义Pistol的弹匣容量、初始化了弹匣中子弹数量和武器的现有剩余弹药。这一点非常聪明。在玩家获得一个新的Item，也就是InventoryManagerComponent的InventoryList进行一次AddEntry时，就会调用ItemDefinition中的每一条Fragment的OnInstanceCreated方法（如果有实现的话），这样就完成了对Item的Stack等信息的初始化。</p>
<h5 id="pickuppable">Pickuppable</h5>
<p>​   值得注意的是，Lyra中的Pickup武器其实不是实际意义上的”拾取“了”武器“，而是通过B_WeaponSpawner的碰撞检测体积的OnOverlapBegin委托，通过对进入碰撞体积的Pawn执行AttemptPickUpWeapon_Implementation，试图对其GiveWeapon。所以并不是依靠一个游戏中的Weapon的掉落物实体和Pawn的交互实现的获取一个Weapon。</p>
<p>LyraWeaponSpawner的一些相关的函数实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ALyraWeaponSpawner::OnOverlapBegin</span><span class="p">(</span><span class="n">UPrimitiveComponent</span><span class="o">*</span><span class="w"> </span><span class="n">OverlappedComponent</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">OtherActor</span><span class="p">,</span><span class="w"> </span><span class="n">UPrimitiveComponent</span><span class="o">*</span><span class="w"> </span><span class="n">OtherComp</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">OtherBodyIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bFromSweep</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FHitResult</span><span class="o">&amp;</span><span class="w"> </span><span class="n">SweepHitResult</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">OverlappingPawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OtherActor</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetLocalRole</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ROLE_Authority</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bIsWeaponAvailable</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">OverlappingPawn</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">AttemptPickUpWeapon</span><span class="p">(</span><span class="n">OverlappingPawn</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ALyraWeaponSpawner::AttemptPickUpWeapon_Implementation</span><span class="p">(</span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetLocalRole</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ROLE_Authority</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bIsWeaponAvailable</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">UAbilitySystemBlueprintLibrary</span><span class="o">::</span><span class="n">GetAbilitySystemComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">WeaponItemDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WeaponDefinition</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">WeaponDefinition</span><span class="o">-&gt;</span><span class="n">InventoryItemDefinition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">WeaponItemDefinition</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="c1">//Attempt to grant the weapon</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GiveWeapon</span><span class="p">(</span><span class="n">WeaponItemDefinition</span><span class="p">,</span><span class="w"> </span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="c1">//Weapon picked up by pawn</span>
<span class="w">             </span><span class="n">bIsWeaponAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">             </span><span class="n">SetWeaponPickupVisibility</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">             </span><span class="n">PlayPickupEffects</span><span class="p">();</span>
<span class="w">             </span><span class="n">StartCoolDown</span><span class="p">();</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span><span class="w">     </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   此外，貌似每个WeaponSpawner能够产生的Weapon种类是固定的，其只持有了一个TSubClassOf<ULyraInventoryItemDefinition>，没有啥随机性。</p>
<p>​   再者，WeaponSpawner基本上就是一个用来制造一个武器产生点位的简单的Actor，没有太多特别之处。</p>
<p>​   </p>
<p>​   Lyra中真正实现了Pickupable的东西只有两个用来做测试的东西，它们在ShooterExplorer/Content/Items中，但是这两个东西的实际交互貌似是没有做完的，虽然可以和其进行交互（例如B_InteractableRock可以被捡起来），但是实际上并不能将其收入物品栏，物品栏UI中的显示也是没做完的。具体原因：<a href="https://garashka.github.io/LyraDocs/lyra/fixing-inventory-system.html">garashka.github.io</a></p>
<p>​   这两个“可拾取物”继承自LyraWorldCollectable，这是一个比较简单的用来实现“拾取”逻辑的Actor，其继承了IPickupable接口和IInteractableTarget接口。主要是靠子类实现接口来实现“<strong>可被拾取”</strong>和<strong>“可添加Item实例到玩家Inventory”</strong>的机制，LyraWorldCollectable连StaticMesh都没有提供，全靠子类补充。</p>
<p>​   子类实现IInteractableTarget接口主要是为了实现“主动地拾取”的机制，这点涉及到Lyra的交互，具体的交互逻辑在PART IV展开。</p>
<p>LyraWorldCollectable.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameFramework/Actor.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Interaction/IInteractableTarget.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Interaction/InteractionOption.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Inventory/IPickupable.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraWorldCollectable.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FInteractionQuery</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">Abstract</span><span class="p">,</span><span class="w"> </span><span class="n">Blueprintable</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ALyraWorldCollectable</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">AActor</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IInteractableTarget</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IPickupable</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ALyraWorldCollectable</span><span class="p">();</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">GatherInteractionOptions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionQuery</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractQuery</span><span class="p">,</span><span class="w"> </span><span class="n">FInteractionOptionBuilder</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractionBuilder</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">FInventoryPickup</span><span class="w"> </span><span class="nf">GetPickupInventory</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">)</span>
<span class="w">    </span><span class="n">FInteractionOption</span><span class="w"> </span><span class="n">Option</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">)</span>
<span class="w">    </span><span class="n">FInventoryPickup</span><span class="w"> </span><span class="n">StaticInventory</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>IPickupable.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Kismet/BlueprintFunctionLibrary.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Templates/SubclassOf.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;UObject/Interface.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;UObject/ObjectPtr.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;IPickupable.generated.h&quot;</span>

<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">InterfaceType</span><span class="o">&gt;</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TScriptInterface</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AActor</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemDefinition</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryItemInstance</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInventoryManagerComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>

<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FPickupTemplate</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">StackCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemDef</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FPickupInstance</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FInventoryPickup</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FPickupInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instances</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FPickupTemplate</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Templates</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**  */</span>
<span class="n">UINTERFACE</span><span class="p">(</span><span class="n">MinimalAPI</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CannotImplementInterfaceInBlueprint</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UPickupable</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UInterface</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>
<span class="p">};</span>

<span class="cm">/**  */</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IPickupable</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">FInventoryPickup</span><span class="w"> </span><span class="n">GetPickupInventory</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**  */</span>
<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UPickupableStatics</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UBlueprintFunctionLibrary</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPickupableStatics</span><span class="p">();</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IPickupable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetFirstPickupableFromActor</span><span class="p">(</span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">Actor</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">WorldContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Ability&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">AddPickupToInventory</span><span class="p">(</span><span class="n">ULyraInventoryManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InventoryComponent</span><span class="p">,</span><span class="w"> </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IPickupable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pickup</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<h2 id="2-lyraequipment">2. LyraEquipment</h2>
<p>​   现在再来看一下和Item很相似的Equipment。</p>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystem/LyraAbilitySet.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Components/PawnComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Net/Serialization/FastArraySerializer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraEquipmentManagerComponent.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UActorComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySystemComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentDefinition</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentInstance</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentManagerComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraEquipmentList</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FNetDeltaSerializeInfo</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FReplicationFlags</span><span class="p">;</span>

<span class="cm">/** A single piece of applied equipment */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAppliedEquipmentEntry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FLyraEquipmentList</span><span class="p">;</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The equipment class that got equipped</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Authority-only list of granted handles</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="w"> </span><span class="n">GrantedHandles</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/** List of applied equipment */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraEquipmentList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializer</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="p">()</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="p">(</span><span class="n">UActorComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">//~FFastArraySerializer contract</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//~End of FFastArraySerializer contract</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">NetDeltaSerialize</span><span class="p">(</span><span class="n">FNetDeltaSerializeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">FFastArraySerializer</span><span class="o">::</span><span class="n">FastArrayDeltaSerialize</span><span class="o">&lt;</span><span class="n">FLyraAppliedEquipmentEntry</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraEquipmentList</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Entries</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RemoveEntry</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">GetAbilitySystemComponent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Replicated list of equipment entries</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAppliedEquipmentEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Entries</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UActorComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">TStructOpsTypeTraits</span><span class="o">&lt;</span><span class="n">FLyraEquipmentList</span><span class="o">&gt;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TStructOpsTypeTraitsBase2</span><span class="o">&lt;</span><span class="n">FLyraEquipmentList</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">WithNetDeltaSerializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">};</span>










<span class="cm">/**</span>
<span class="cm"> * Manages equipment applied to a pawn</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPawnComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">EquipItem</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">UnequipItem</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ReplicateSubobjects</span><span class="p">(</span><span class="k">class</span><span class="w"> </span><span class="nc">UActorChannel</span><span class="o">*</span><span class="w"> </span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FOutBunch</span><span class="o">*</span><span class="w"> </span><span class="n">Bunch</span><span class="p">,</span><span class="w"> </span><span class="n">FReplicationFlags</span><span class="o">*</span><span class="w"> </span><span class="n">RepFlags</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="w">    </span><span class="c1">//~UActorComponent interface</span>
<span class="w">    </span><span class="c1">//virtual void EndPlay() override;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">InitializeComponent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">UninitializeComponent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UActorComponent interface</span>

<span class="w">    </span><span class="cm">/** Returns the first equipped instance of a given type, or nullptr if none are found */</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">GetFirstInstanceOfType</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/** Returns all equipped instances of a given type, or an empty array if none are found */</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetEquipmentInstancesOfType</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">GetFirstInstanceOfType</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="p">)</span><span class="n">GetFirstInstanceOfType</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="w"> </span><span class="n">EquipmentList</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="21-equipmentmanagercomponent">2.1 EquipmentManagerComponent</h3>
<p>​   LyraEquipmentManagerComponent由Pawn拥有。</p>
<h4 id="211-entryequipmentinstanceequipmentdefinition">2.1.1 Entry与EquipmentInstance和EquipmentDefinition</h4>
<div class="highlight"><pre><span></span><code><span class="cm">/** A single piece of applied equipment */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAppliedEquipmentEntry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FLyraEquipmentList</span><span class="p">;</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The equipment class that got equipped</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Authority-only list of granted handles</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="w"> </span><span class="n">GrantedHandles</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h5 id="equipmentinstance">EquipmentInstance</h5>
<p>​   EquipmentManagerComponent中的Entry和Inventory有相似之处也有不同，不同之处在于Entry维护多了一个EquipmentDefinition而没有Count。值得注意的是，Equipment的Instance和Inventory的Instance有点不同 ，Inventory的Instance更多是意在维护一个Item实例的数量，而Equipment的Instance则完全不是这样，EquipmentManagerComponent中不需要研究一个Equipment“有多少”，它只研究“是否装备”，“有多少”是Inventory中管理的事情，EquipmentManager要做的就是明确一件Equipment的各项信息，因此，实际上EquipmentInstance还是一种<strong>Definition</strong>，针对不同的类型的Equipment派生出不同的属性。</p>
<p>​   EquipmentInstance先派生了一个C++类LyraWeaponInstance，再从这个类派生了LyraRangedWeaponInstance，其中新增了很多的属性，<strong>逐步细化</strong>了一把RangedWeapon应该要有的东西，然后派生成蓝图类的一个基类，再派生成其他的真正的武器数据，例如Pistol、Shotgun等等武器，属性有例如以下这些像有效伤害范围、伤害随距离衰减、子弹散布、装备或卸下的时候播放的蒙太奇等等。</p>
<p><img alt="image-20250129145756756" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129145756756.png" /></p>
<p><img alt="image-20250129145827793" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129145827793.png" /></p>
<h5 id="equipmentdefinition"><strong>EquipmentDefinition</strong></h5>
<p>​   EquipmentInstance实际上还是一种Definition，那么EquipmentDefinition是什么？</p>
<p>​   EquipmentDefinition其实是涵盖了EquipmentInstance的一个<strong>更大的</strong>一个Definition，它包含了一个EquipmentInstance，还有这个Equipment要赋予装备者的Ability的信息（AbilitySet），还有一个如何装备的信息的结构体（FLyraEquipmentActorToSpawn）。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Templates/SubclassOf.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraEquipmentDefinition.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AActor</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySet</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentInstance</span><span class="p">;</span>

<span class="n">USTRUCT</span><span class="p">()</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraEquipmentActorToSpawn</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraEquipmentActorToSpawn</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">AActor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ActorToSpawn</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">FName</span><span class="w"> </span><span class="n">AttachSocket</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">FTransform</span><span class="w"> </span><span class="n">AttachTransform</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraEquipmentDefinition</span>
<span class="cm"> *</span>
<span class="cm"> * Definition of a piece of equipment that can be applied to a pawn</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">,</span><span class="w"> </span><span class="n">Abstract</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentDefinition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraEquipmentDefinition</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Class to spawn</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Gameplay ability sets to grant when this is equipped</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraAbilitySet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">AbilitySetsToGrant</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Actors to spawn on the pawn when this is equipped</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Equipment</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraEquipmentActorToSpawn</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ActorsToSpawn</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p><strong>例子：WID_Pistol中的各种配置：</strong></p>
<p><img alt="image-20250129154040391" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129154040391.png" /></p>
<h5 id="addentry_1">AddEntry的实现</h5>
<div class="highlight"><pre><span></span><code><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">FLyraEquipmentList::AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">EquipmentDefinition</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">HasAuthority</span><span class="p">());</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraEquipmentDefinition</span><span class="o">*</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDefault</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="p">(</span><span class="n">EquipmentDefinition</span><span class="p">);</span>

<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">InstanceType</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InstanceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">InstanceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraEquipmentInstance</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">.</span><span class="n">AddDefaulted_GetRef</span><span class="p">();</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">EquipmentDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">(),</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">);</span><span class="w">  </span><span class="c1">//@TODO: Using the actor instead of component as the outer due to UE-127172</span>
<span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">ASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbilitySystemComponent</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraAbilitySet</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">AbilitySet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">AbilitySetsToGrant</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">AbilitySet</span><span class="o">-&gt;</span><span class="n">GiveToAbilitySystem</span><span class="p">(</span><span class="n">ASC</span><span class="p">,</span><span class="w"> </span><span class="cm">/*inout*/</span><span class="w"> </span><span class="o">&amp;</span><span class="n">NewEntry</span><span class="p">.</span><span class="n">GrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//@TODO: Warning logging?</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Result</span><span class="o">-&gt;</span><span class="n">SpawnEquipmentActors</span><span class="p">(</span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">ActorsToSpawn</span><span class="p">);</span>


<span class="w">    </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">NewEntry</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   可以关注到AddEntry还涉及到了把Equipment上的<strong>“AbilitySet”</strong>通过AbilitySet-&gt;GiveToAbilitySystem给授予这个装备者的ASC。AbilitySet实际上是一个PrimaryDataAsset，里面维护了三个和GAS相关的属性：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * ULyraAbilitySet</span>
<span class="cm"> *</span>
<span class="cm"> *  Non-mutable data asset used to grant gameplay abilities and gameplay effects.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPrimaryDataAsset</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraAbilitySet</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Grants the ability set to the specified ability system component.</span>
<span class="w">    </span><span class="c1">// The returned handles can be used later to take away anything that was granted.</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">GiveToAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="o">*</span><span class="w"> </span><span class="n">OutGrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">UObject</span><span class="o">*</span><span class="w"> </span><span class="n">SourceObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay abilities to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Gameplay Abilities&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">Ability</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_GameplayAbility</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Gameplay effects to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Gameplay Effects&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">GameplayEffect</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_GameplayEffect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Attribute sets to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Attribute Sets&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">AttributeSet</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_AttributeSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>具体的涉及的结构体的定义，随便看看就行：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GameplayAbility</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant gameplay abilities.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GameplayAbility</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay ability to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraGameplayAbility</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Ability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Level of ability to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">AbilityLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Tag used to process input for the ability.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;InputTag&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InputTag</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GameplayEffect</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant gameplay effects.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GameplayEffect</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">UGameplayEffect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GameplayEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Level of gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">EffectLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_AttributeSet</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant attribute sets.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_AttributeSet</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AttributeSet</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GrantedHandles</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used to store handles to what has been granted by the ability set.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GrantedHandles</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddAbilitySpecHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddGameplayEffectHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddAttributeSet</span><span class="p">(</span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">Set</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">TakeFromAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Handles to the granted abilities.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AbilitySpecHandles</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Handles to the granted gameplay effects.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GameplayEffectHandles</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Pointers to the granted attribute sets</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GrantedAttributeSets</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h6 id="abilitysetgivetoabilitysystem">AbilitySet的GiveToAbilitySystem的实现：</h6>
<p>​   本质上就是把AbilitySet中打包好的信息拿出来，按照上面的信息去把GAS相关的东西给到目标的ASC，例如对于装备来说，就给一些Ability，让Player的ASC获得这些ASC然后可以去用。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraAbilitySet::GiveToAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="o">*</span><span class="w"> </span><span class="n">OutGrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">UObject</span><span class="o">*</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">IsOwnerActorAuthoritative</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Must be authoritative to give or take ability sets.</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the attribute sets.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">SetIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_AttributeSet</span><span class="o">&amp;</span><span class="w"> </span><span class="n">SetToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">[</span><span class="n">SetIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedAttributes[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">SetIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">NewSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">(),</span><span class="w"> </span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">);</span>
<span class="w">       </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">AddAttributeSetSubobject</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAttributeSet</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay abilities.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">AbilityIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayAbility</span><span class="o">&amp;</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">[</span><span class="n">AbilityIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayAbilities[%d] on ability set [%s] is not valid.&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">ULyraGameplayAbility</span><span class="o">*</span><span class="w"> </span><span class="n">AbilityCDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">ULyraGameplayAbility</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">       </span><span class="n">FGameplayAbilitySpec</span><span class="w"> </span><span class="n">AbilitySpec</span><span class="p">(</span><span class="n">AbilityCDO</span><span class="p">,</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">AbilityLevel</span><span class="p">);</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">SourceObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">;</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">GetDynamicSpecSourceTags</span><span class="p">().</span><span class="n">AddTag</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">InputTag</span><span class="p">);</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">AbilitySpecHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GiveAbility</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAbilitySpecHandle</span><span class="p">(</span><span class="n">AbilitySpecHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay effects.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">EffectIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayEffect</span><span class="o">&amp;</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">[</span><span class="n">EffectIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayEffects[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">EffectIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">UGameplayEffect</span><span class="o">*</span><span class="w"> </span><span class="n">GameplayEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">UGameplayEffect</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="w"> </span><span class="n">GameplayEffectHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ApplyGameplayEffectToSelf</span><span class="p">(</span><span class="n">GameplayEffect</span><span class="p">,</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">EffectLevel</span><span class="p">,</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">MakeEffectContext</span><span class="p">());</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddGameplayEffectHandle</span><span class="p">(</span><span class="n">GameplayEffectHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="removeentry_1">RemoveEntry的实现</h5>
<div class="highlight"><pre><span></span><code>void FLyraEquipmentList::RemoveEntry(ULyraEquipmentInstance* Instance)
{
    for (auto EntryIt = Entries.CreateIterator(); EntryIt; ++EntryIt)
    {
       FLyraAppliedEquipmentEntry&amp; Entry = *EntryIt;
       if (Entry.Instance == Instance)
       {
          if (ULyraAbilitySystemComponent* ASC = GetAbilitySystemComponent())
          {
             Entry.GrantedHandles.TakeFromAbilitySystem(ASC);
          }

          Instance-&gt;DestroyEquipmentActors();


          EntryIt.RemoveCurrent();
          MarkArrayDirty();
       }
    }
}
</code></pre></div>
<h4 id="212-equipmentlist">2.1.2 EquipmentList</h4>
<div class="highlight"><pre><span></span><code><span class="cm">/** List of applied equipment */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraEquipmentList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializer</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="p">()</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="p">(</span><span class="n">UActorComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">(</span><span class="n">InOwnerComponent</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">//~FFastArraySerializer contract</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PreReplicatedRemove</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RemovedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AddedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostReplicatedChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArrayView</span><span class="o">&lt;</span><span class="n">int32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChangedIndices</span><span class="p">,</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">FinalSize</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//~End of FFastArraySerializer contract</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">NetDeltaSerialize</span><span class="p">(</span><span class="n">FNetDeltaSerializeInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">FFastArraySerializer</span><span class="o">::</span><span class="n">FastArrayDeltaSerialize</span><span class="o">&lt;</span><span class="n">FLyraAppliedEquipmentEntry</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraEquipmentList</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Entries</span><span class="p">,</span><span class="w"> </span><span class="n">DeltaParms</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RemoveEntry</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">GetAbilitySystemComponent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Replicated list of equipment entries</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAppliedEquipmentEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Entries</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UActorComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OwnerComponent</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   EquipmentList和InventoryList十分相似，也是维护了一个Entry的TArray和一个OwnerComponent，AddEntry和RemoveEntry的思路和InventoryList都是差不多的，注意到List里面特别的还有一个GetAbilitySystemComponent的函数，可知Equipment涉及到了GAS的东西。</p>
<h4 id="213-equipmentmanagercomponent">2.1.3 EquipmentManagerComponent</h4>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Manages equipment applied to a pawn</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPawnComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">EquipItem</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">UnequipItem</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ReplicateSubobjects</span><span class="p">(</span><span class="k">class</span><span class="w"> </span><span class="nc">UActorChannel</span><span class="o">*</span><span class="w"> </span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FOutBunch</span><span class="o">*</span><span class="w"> </span><span class="n">Bunch</span><span class="p">,</span><span class="w"> </span><span class="n">FReplicationFlags</span><span class="o">*</span><span class="w"> </span><span class="n">RepFlags</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="w">    </span><span class="c1">//~UActorComponent interface</span>
<span class="w">    </span><span class="c1">//virtual void EndPlay() override;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">InitializeComponent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">UninitializeComponent</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ReadyForReplication</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//~End of UActorComponent interface</span>

<span class="w">    </span><span class="cm">/** Returns the first equipped instance of a given type, or nullptr if none are found */</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">GetFirstInstanceOfType</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/** Returns all equipped instances of a given type, or an empty array if none are found */</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetEquipmentInstancesOfType</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">GetFirstInstanceOfType</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="p">)</span><span class="n">GetFirstInstanceOfType</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraEquipmentList</span><span class="w"> </span><span class="n">EquipmentList</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h5 id="equipitemunequipitem">EquipItem和UnequipItem</h5>
<p>​   本质上就是去调用EquipmentList的AddEntry和RemoveEntry，并且去触发EquipmentInstance的OnEquipped或OnUnequipped</p>
<div class="highlight"><pre><span></span><code><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraEquipmentManagerComponent::EquipItem</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentClass</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EquipmentClass</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentList</span><span class="p">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="n">EquipmentClass</span><span class="p">);</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">Result</span><span class="o">-&gt;</span><span class="n">OnEquipped</span><span class="p">();</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsUsingRegisteredSubObjectList</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IsReadyForReplication</span><span class="p">())</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">AddReplicatedSubObject</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraEquipmentManagerComponent::UnequipItem</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">ItemInstance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ItemInstance</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsUsingRegisteredSubObjectList</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">RemoveReplicatedSubObject</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">ItemInstance</span><span class="o">-&gt;</span><span class="n">OnUnequipped</span><span class="p">();</span>
<span class="w">       </span><span class="n">EquipmentList</span><span class="p">.</span><span class="n">RemoveEntry</span><span class="p">(</span><span class="n">ItemInstance</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   EquipmentManagerComponent的内容就大概如此，EquipmentManagerComponent只是负责了Equipment的装卸的控制，最重要的功能就是把Equipment带有的Abilities授予给装备者，但是如何使用这些Abilities并非EquipmentManagerComponent的控制范围。由于Lyra中没有“防具”“饰品”之类的其他类型的Equipment，只有Weapon这种Equipment，而Weapon的功能的发挥肯定是要靠玩家输入的，比如像射击、换弹等等，而要使用一把Weapon，肯定要去”选用“它，而这件事情的实现就在LyraQuickBarComponent中，而QuickBar的Slot选取是通过GameplayAbility来实现的。同时，实际上是由QuickBarComponent来决定了装备什么武器，也就是EquipmentManagerComponent是服务于QuickBarComponent选择了哪个槽位中的Weapon的。</p>
<p>​   接下来我们就来看看LyraQuickBarComponent的内容。</p>
<h2 id="3-lyraquickbarcomponent">3. LyraQuickBarComponent</h2>
<h3 id="31-quickbarcomponent">3.1 QuickBarComponent</h3>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Components/ControllerComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Inventory/LyraInventoryItemInstance.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraQuickBarComponent.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AActor</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentInstance</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraEquipmentManagerComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>

<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BlueprintSpawnableComponent</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraQuickBarComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UControllerComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraQuickBarComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Lyra&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">CycleActiveSlotForward</span><span class="p">();</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Lyra&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">CycleActiveSlotBackward</span><span class="p">();</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span><span class="w"> </span><span class="n">Reliable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Lyra&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetActiveSlotIndex</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">NewIndex</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">GetSlots</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">Slots</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">GetActiveSlotIndex</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">GetActiveSlotItem</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">GetNextFreeItemSlot</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddItemToSlot</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">,</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Item</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintAuthorityOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">RemoveItemFromSlot</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">BeginPlay</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">UnequipItemInSlot</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">EquipItemInSlot</span><span class="p">();</span>

<span class="w">    </span><span class="n">ULyraEquipmentManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="nf">FindEquipmentManager</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">NumSlots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_Slots</span><span class="p">();</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_ActiveSlotIndex</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">ReplicatedUsing</span><span class="o">=</span><span class="n">OnRep_Slots</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Slots</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">ReplicatedUsing</span><span class="o">=</span><span class="n">OnRep_ActiveSlotIndex</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquippedItem</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   QuickBarComponent主要维护了几个东西：</p>
<ul>
<li>一个TArray<TObjectPtr\<ULyraInventoryItemInstance>> Slots;</li>
<li>一个int32 NumSlots = 3;</li>
<li>一个int32 ActiveSlotIndex = -1;</li>
<li>一个TObjectPtr<ULyraEquipmentInstance> EquippedItem;</li>
</ul>
<p>​   Slots管理了存在于QuickBar中的ItemInstance，注意是<strong>ItemInstance</strong>。</p>
<p>​   NumSlots写死了QuickBar的容量，决定了Slots实际上能存有多少个ItemInstance</p>
<p>​   ActiveSlotIndex表示了正在激活的Slot的编号，-1代表无激活。</p>
<p>​   EquippedItem是一个对当前装备着的Item的引用。</p>
<p>.cpp</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::CycleActiveSlotForward</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">OldIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">);</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">NewIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">NewIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NewIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">[</span><span class="n">NewIndex</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">SetActiveSlotIndex</span><span class="p">(</span><span class="n">NewIndex</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">NewIndex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OldIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::CycleActiveSlotBackward</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">int32</span><span class="w"> </span><span class="n">OldIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">);</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">NewIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">NewIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NewIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">())</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">[</span><span class="n">NewIndex</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">SetActiveSlotIndex</span><span class="p">(</span><span class="n">NewIndex</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">NewIndex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OldIndex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::EquipItemInSlot</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="p">));</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">EquippedItem</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">SlotItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Slots</span><span class="p">[</span><span class="n">ActiveSlotIndex</span><span class="p">])</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UInventoryFragment_EquippableItem</span><span class="o">*</span><span class="w"> </span><span class="n">EquipInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SlotItem</span><span class="o">-&gt;</span><span class="n">FindFragmentByClass</span><span class="o">&lt;</span><span class="n">UInventoryFragment_EquippableItem</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipDef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipInfo</span><span class="o">-&gt;</span><span class="n">EquipmentDefinition</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EquipDef</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraEquipmentManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="n">EquipmentManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindEquipmentManager</span><span class="p">())</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="n">EquippedItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentManager</span><span class="o">-&gt;</span><span class="n">EquipItem</span><span class="p">(</span><span class="n">EquipDef</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EquippedItem</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                   </span><span class="n">EquippedItem</span><span class="o">-&gt;</span><span class="n">SetInstigator</span><span class="p">(</span><span class="n">SlotItem</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::UnequipItemInSlot</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraEquipmentManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="n">EquipmentManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindEquipmentManager</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EquippedItem</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">EquipmentManager</span><span class="o">-&gt;</span><span class="n">UnequipItem</span><span class="p">(</span><span class="n">EquippedItem</span><span class="p">);</span>
<span class="w">          </span><span class="n">EquippedItem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">ULyraEquipmentManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::FindEquipmentManager</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AController</span><span class="o">*</span><span class="w"> </span><span class="n">OwnerController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">AController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">()))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OwnerController</span><span class="o">-&gt;</span><span class="n">GetPawn</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">FindComponentByClass</span><span class="o">&lt;</span><span class="n">ULyraEquipmentManagerComponent</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::SetActiveSlotIndex_Implementation</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">NewIndex</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="n">NewIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NewIndex</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">UnequipItemInSlot</span><span class="p">();</span>

<span class="w">       </span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewIndex</span><span class="p">;</span>

<span class="w">       </span><span class="n">EquipItemInSlot</span><span class="p">();</span>

<span class="w">       </span><span class="n">OnRep_ActiveSlotIndex</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::GetActiveSlotItem</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Slots</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Slots</span><span class="p">[</span><span class="n">ActiveSlotIndex</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">int32</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::GetNextFreeItemSlot</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">SlotIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInventoryItemInstance</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">ItemPtr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Slots</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ItemPtr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">       </span><span class="o">++</span><span class="n">SlotIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::AddItemToSlot</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">,</span><span class="w"> </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Item</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="n">SlotIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Item</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">Slots</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Item</span><span class="p">;</span>
<span class="w">          </span><span class="n">OnRep_Slots</span><span class="p">();</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::RemoveItemFromSlot</span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraInventoryItemInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SlotIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">UnequipItemInSlot</span><span class="p">();</span>
<span class="w">       </span><span class="n">ActiveSlotIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Slots</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="n">SlotIndex</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Slots</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">Slots</span><span class="p">[</span><span class="n">SlotIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">          </span><span class="n">OnRep_Slots</span><span class="p">();</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::OnRep_Slots</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">FLyraQuickBarSlotsChangedMessage</span><span class="w"> </span><span class="n">Message</span><span class="p">;</span>
<span class="w">    </span><span class="n">Message</span><span class="p">.</span><span class="n">Owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetOwner</span><span class="p">();</span>
<span class="w">    </span><span class="n">Message</span><span class="p">.</span><span class="n">Slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Slots</span><span class="p">;</span>

<span class="w">    </span><span class="n">UGameplayMessageSubsystem</span><span class="o">&amp;</span><span class="w"> </span><span class="n">MessageSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UGameplayMessageSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="n">MessageSystem</span><span class="p">.</span><span class="n">BroadcastMessage</span><span class="p">(</span><span class="n">TAG_Lyra_QuickBar_Message_SlotsChanged</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraQuickBarComponent::OnRep_ActiveSlotIndex</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">FLyraQuickBarActiveIndexChangedMessage</span><span class="w"> </span><span class="n">Message</span><span class="p">;</span>
<span class="w">    </span><span class="n">Message</span><span class="p">.</span><span class="n">Owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetOwner</span><span class="p">();</span>
<span class="w">    </span><span class="n">Message</span><span class="p">.</span><span class="n">ActiveIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActiveSlotIndex</span><span class="p">;</span>

<span class="w">    </span><span class="n">UGameplayMessageSubsystem</span><span class="o">&amp;</span><span class="w"> </span><span class="n">MessageSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UGameplayMessageSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="n">MessageSystem</span><span class="p">.</span><span class="n">BroadcastMessage</span><span class="p">(</span><span class="n">TAG_Lyra_QuickBar_Message_ActiveIndexChanged</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>​   主要关注和<strong>选择</strong>”Slot“相关的函数，其大致思路就是去选择QuickBar的Slot，被选取的Slot就通过函数SetActiveSlotIndex更新为ActiveSlot。在调用SetActiveSlotIndex函数时还会去装备上当前选中的QuickBarSlot中的Item，当然前置的一个逻辑就是先把之前装备的Item给卸载掉，这就又涉及到前面EquipmentManagerComponent中的装卸Equipment的逻辑了。</p>
<p>​   BTW通过ULyraQuickBarComponent::FindEquipmentManager()可以看出EquipmentManagerComponent是挂在<strong>Pawn</strong>上而QuickBarComponent都是挂载在<strong>Controller</strong>上的，还可以观察到Lyra中普遍的获取一个Actor上的Component的方式，即直接通过遍历Actor上的OwnedComponents去暴力找出对应Class的Component，而不是通过接口之类的或者是定义一个成员变量初始化之后一直拿着对应Component的引用可以去用。（这是不是不太好？）</p>
<p>​   此外还可以看到，这里使用了FindComponentByClass而不是GetComponentByClass，是因为FindComponentByClass返回的就是Find的Class而不是返回一个UActorComponent指针，这样就不需要再多一步Cast&lt;&gt;()。</p>
<p><img alt="image-20250129170028488" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250129170028488.png" /></p>
<h4 id="311-quickbarslot">3.1.1 QuickBarSlot 的选择</h4>
<p>​   QuickBarSlot 的选择的具体逻辑在QuickBarComponent中实现了，但是其触发的地方值得研究。</p>
<p>​   首先，Lyra使用了一个GameplayAbility——GA_QucikBarSlots来实现对QuickBar输入的接收，这是一个没有EndAbility的GA，也就说明它是一个被动“技能”，它的作用就是<strong>永久性地监听</strong>GameplayEvent，来实现QuickBar的选择的改变</p>
<p><img alt="image-20250213165147768" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250213165147768.png" /></p>
<p>​   当接收到GameplayEvent时，它就会调用QuickBarComponent中对应的逻辑。</p>
<p><img alt="image-20250213165259665" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250213165259665.png" />  而GameplayEvent的发送是由Character直接完成的，它绑定了QuickBar相关的IA，实现了发送GameplayEvent</p>
<p><img alt="image-20250213165422437" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250213165422437.png" /></p>
<p>​   Lyra的Character中，无论是用数字键指定地设置选中的Slot还是用鼠标滚轮，都共用了同一个内部的函数ChangeQuickBarSlot，即使鼠标滚轮的选取不需要输入NewSlotIndex，这样的程序设计是不错的。</p>
<p><img alt="image-20250213165758144" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250213165758144.png" /></p>
<p>​   </p>
<p>​   Lyra的Inventory相关的内容就大概如此。</p>
<h2 id="part-ii-gameplayabilitysystem">PART II GameplayAbilitySystem</h2>
<p>​   首先来看Lyra的AttributeSet基类。Lyra的AttributeSet基类LyraAttributeSet设计得很有意思，首先Lyra用一个基本算没什么东西的基类，先把创建Attribute的帮助宏给引入了，然后派生的有实际意义的AttributeSet引入了基类的头文件，就相当于引入了帮助宏，而且LyraAttributeSet还定义了一个<strong>多播委托FLyraAttributeEvent</strong>，用于管理Attribute相关的事件广播。</p>
<h3 id="1-attributeset">1. AttributeSet</h3>
<h4 id="11-lyraattributesetlyraattributeset">1.1 LyraAttributeSet——Lyra中的AttributeSet的基类</h4>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AttributeSet.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAttributeSet.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AActor</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySystemComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UWorld</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayEffectSpec</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * This macro defines a set of helper functions for accessing and initializing attributes.</span>
<span class="cm"> *</span>
<span class="cm"> * The following example of the macro:</span>
<span class="cm"> *     ATTRIBUTE_ACCESSORS(ULyraHealthSet, Health)</span>
<span class="cm"> * will create the following functions:</span>
<span class="cm"> *     static FGameplayAttribute GetHealthAttribute();</span>
<span class="cm"> *     float GetHealth() const;</span>
<span class="cm"> *     void SetHealth(float NewVal);</span>
<span class="cm"> *     void InitHealth(float NewVal);</span>
<span class="cm"> */</span>
<span class="cp">#define ATTRIBUTE_ACCESSORS(ClassName, PropertyName) \</span>
<span class="cp">    GAMEPLAYATTRIBUTE_PROPERTY_GETTER(ClassName, PropertyName) \</span>
<span class="cp">    GAMEPLAYATTRIBUTE_VALUE_GETTER(PropertyName) \</span>
<span class="cp">    GAMEPLAYATTRIBUTE_VALUE_SETTER(PropertyName) \</span>
<span class="cp">    GAMEPLAYATTRIBUTE_VALUE_INITTER(PropertyName)</span>

<span class="cm">/** </span>
<span class="cm"> * Delegate used to broadcast attribute events, some of these parameters may be null on clients: </span>
<span class="cm"> * @param EffectInstigator  The original instigating actor for this event</span>
<span class="cm"> * @param EffectCauser     The physical actor that caused the change</span>
<span class="cm"> * @param EffectSpec       The full effect spec for this change</span>
<span class="cm"> * @param EffectMagnitude   The raw magnitude, this is before clamping</span>
<span class="cm"> * @param OldValue        The value of the attribute before it was changed</span>
<span class="cm"> * @param NewValue        The value after it was changed</span>
<span class="cm">*/</span>
<span class="n">DECLARE_MULTICAST_DELEGATE_SixParams</span><span class="p">(</span><span class="n">FLyraAttributeEvent</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="cm">/*EffectInstigator*/</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="cm">/*EffectCauser*/</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectSpec</span><span class="o">*</span><span class="w"> </span><span class="cm">/*EffectSpec*/</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="cm">/*EffectMagnitude*/</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="cm">/*OldValue*/</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="cm">/*NewValue*/</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ULyraAttributeSet</span>
<span class="cm"> *</span>
<span class="cm"> *  Base attribute set class for the project.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraAttributeSet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UAttributeSet</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraAttributeSet</span><span class="p">();</span>

<span class="w">    </span><span class="n">UWorld</span><span class="o">*</span><span class="w"> </span><span class="nf">GetWorld</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="nf">GetLyraAbilitySystemComponent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h4 id="12-heathset">1.2 HeathSet</h4>
<p>​   Lyra专门设置了一个HealthSet来管理Lyra的生命值，其中使用到了MetaAttribute的概念，即Healing和Damage</p>
<p>​   接下再来看HealthSet。</p>
<p>​   首先一上来使用了一些Lyra中定义的声明NativeTag的宏来声明一些相关的GameplayTag，暂时可以不用管。</p>
<p>​   接着是很常规的使用帮助宏创建其他东西。</p>
<p>​   接着是声明几个了LyraAttributeSet中定义的委托类型的委托实例用来广播Attribute变化（这里就只是关于Health），以及Health为0的情况。</p>
<blockquote>
<p>[!NOTE]</p>
<p>​ 这里委托变量前面的关键字<strong>mutable</strong>是和关键字const相反作用的，它可以使得修饰的变量能够突破const函数限制修改类成员的限制，被mutable关键字修饰过的变量即使出现在类的const函数中也允许被修改。</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystemComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAttributeSet.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NativeGameplayTags.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraHealthSet.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>

<span class="n">LYRAGAME_API</span><span class="w"> </span><span class="nf">UE_DECLARE_GAMEPLAY_TAG_EXTERN</span><span class="p">(</span><span class="n">TAG_Gameplay_Damage</span><span class="p">);</span>
<span class="n">LYRAGAME_API</span><span class="w"> </span><span class="nf">UE_DECLARE_GAMEPLAY_TAG_EXTERN</span><span class="p">(</span><span class="n">TAG_Gameplay_DamageImmunity</span><span class="p">);</span>
<span class="n">LYRAGAME_API</span><span class="w"> </span><span class="nf">UE_DECLARE_GAMEPLAY_TAG_EXTERN</span><span class="p">(</span><span class="n">TAG_Gameplay_DamageSelfDestruct</span><span class="p">);</span>
<span class="n">LYRAGAME_API</span><span class="w"> </span><span class="nf">UE_DECLARE_GAMEPLAY_TAG_EXTERN</span><span class="p">(</span><span class="n">TAG_Gameplay_FellOutOfWorld</span><span class="p">);</span>
<span class="n">LYRAGAME_API</span><span class="w"> </span><span class="nf">UE_DECLARE_GAMEPLAY_TAG_EXTERN</span><span class="p">(</span><span class="n">TAG_Lyra_Damage_Message</span><span class="p">);</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayEffectModCallbackData</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraHealthSet</span>
<span class="cm"> *</span>
<span class="cm"> *  Class that defines attributes that are necessary for taking damage.</span>
<span class="cm"> *  Attribute examples include: health, shields, and resistances.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraHealthSet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ULyraAttributeSet</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraHealthSet</span><span class="p">();</span>

<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraHealthSet</span><span class="p">,</span><span class="w"> </span><span class="n">Health</span><span class="p">);</span>
<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraHealthSet</span><span class="p">,</span><span class="w"> </span><span class="n">MaxHealth</span><span class="p">);</span>
<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraHealthSet</span><span class="p">,</span><span class="w"> </span><span class="n">Healing</span><span class="p">);</span>
<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraHealthSet</span><span class="p">,</span><span class="w"> </span><span class="n">Damage</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Delegate when health changes due to damage/healing, some information may be missing on the client</span>
<span class="w">    </span><span class="k">mutable</span><span class="w"> </span><span class="n">FLyraAttributeEvent</span><span class="w"> </span><span class="n">OnHealthChanged</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Delegate when max health changes</span>
<span class="w">    </span><span class="k">mutable</span><span class="w"> </span><span class="n">FLyraAttributeEvent</span><span class="w"> </span><span class="n">OnMaxHealthChanged</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Delegate to broadcast when the health attribute reaches zero</span>
<span class="w">    </span><span class="k">mutable</span><span class="w"> </span><span class="n">FLyraAttributeEvent</span><span class="w"> </span><span class="n">OnOutOfHealth</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_Health</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_MaxHealth</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">PreGameplayEffectExecute</span><span class="p">(</span><span class="n">FGameplayEffectModCallbackData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Data</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostGameplayEffectExecute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectModCallbackData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Data</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PreAttributeBaseChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PreAttributeChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostAttributeChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ClampAttribute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// The current health attribute.  The health will be capped by the max health attribute.  Health is hidden from modifiers so only executions can modify it.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">ReplicatedUsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnRep_Health</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HideFromModifiers</span><span class="p">,</span><span class="w"> </span><span class="n">AllowPrivateAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">Health</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The current max health attribute.  Max health is an attribute since gameplay effects can modify it.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">ReplicatedUsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnRep_MaxHealth</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AllowPrivateAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">MaxHealth</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Used to track when the health reaches 0.</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">bOutOfHealth</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Store the health before any changes </span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">MaxHealthBeforeAttributeChange</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">HealthBeforeAttributeChange</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// -------------------------------------------------------------------</span>
<span class="w">    </span><span class="c1">// Meta Attribute (please keep attributes that aren&#39;t &#39;stateful&#39; below </span>
<span class="w">    </span><span class="c1">// -------------------------------------------------------------------</span>

<span class="w">    </span><span class="c1">// Incoming healing. This is mapped directly to +Health</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="o">=</span><span class="p">(</span><span class="n">AllowPrivateAccess</span><span class="o">=</span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">Healing</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Incoming damage. This is mapped directly to -Health</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="o">=</span><span class="p">(</span><span class="n">HideFromModifiers</span><span class="p">,</span><span class="w"> </span><span class="n">AllowPrivateAccess</span><span class="o">=</span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">Damage</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   接着来看.cpp中各种函数，首先先来看Pre/PostGameplayEffectExcute：</p>
<h5 id="pregameplayeffectexcute">PreGameplayEffectExcute</h5>
<div class="highlight"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">ULyraHealthSet::PreGameplayEffectExecute</span><span class="p">(</span><span class="n">FGameplayEffectModCallbackData</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Super</span><span class="o">::</span><span class="n">PreGameplayEffectExecute</span><span class="p">(</span><span class="n">Data</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Handle modifying incoming normal damage</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetDamageAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bIsDamageFromSelfDestruct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">GetDynamicAssetTags</span><span class="p">().</span><span class="n">HasTagExact</span><span class="p">(</span><span class="n">TAG_Gameplay_DamageSelfDestruct</span><span class="p">);</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">HasMatchingGameplayTag</span><span class="p">(</span><span class="n">TAG_Gameplay_DamageImmunity</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bIsDamageFromSelfDestruct</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// Do not take away any health.</span>
<span class="w">             </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>

<span class="cp">#if !UE_BUILD_SHIPPING</span>
<span class="w">          </span><span class="c1">// Check GodMode cheat, unlimited health is checked below</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">HasMatchingGameplayTag</span><span class="p">(</span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">Cheat_GodMode</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bIsDamageFromSelfDestruct</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// Do not take away any health.</span>
<span class="w">             </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// #if !UE_BUILD_SHIPPING</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Save the current health</span>
<span class="w">    </span><span class="n">HealthBeforeAttributeChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetHealth</span><span class="p">();</span>
<span class="w">    </span><span class="n">MaxHealthBeforeAttributeChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   PreGameplayEffect中比较重要的是对伤害条件进行了一些判断，以及存储了一下在GE生效前的Health和MaxHealth（Attribute）的值，以便后面PostGameplayEffectExcute中判断是否要广播HealthChange的时候要用到，这点很重要。</p>
<h5 id="postgameplayeffectexcute">PostGameplayEffectExcute</h5>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHealthSet::PostGameplayEffectExecute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectModCallbackData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">PostGameplayEffectExecute</span><span class="p">(</span><span class="n">Data</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bIsDamageFromSelfDestruct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">GetDynamicAssetTags</span><span class="p">().</span><span class="n">HasTagExact</span><span class="p">(</span><span class="n">TAG_Gameplay_DamageSelfDestruct</span><span class="p">);</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">MinimumHealth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>

<span class="cp">#if !UE_BUILD_SHIPPING</span>
<span class="w">    </span><span class="c1">// Godmode and unlimited health stop death unless it&#39;s a self destruct</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bIsDamageFromSelfDestruct</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">       </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">HasMatchingGameplayTag</span><span class="p">(</span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">Cheat_GodMode</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">HasMatchingGameplayTag</span><span class="p">(</span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">Cheat_UnlimitedHealth</span><span class="p">)</span><span class="w"> </span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">MinimumHealth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// #if !UE_BUILD_SHIPPING</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectContextHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">EffectContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">GetEffectContext</span><span class="p">();</span>
<span class="w">    </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">Instigator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EffectContext</span><span class="p">.</span><span class="n">GetOriginalInstigator</span><span class="p">();</span>
<span class="w">    </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">Causer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EffectContext</span><span class="p">.</span><span class="n">GetEffectCauser</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetDamageAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Send a standardized verb message that other systems can observe</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">FLyraVerbMessage</span><span class="w"> </span><span class="n">Message</span><span class="p">;</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">Verb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAG_Lyra_Damage_Message</span><span class="p">;</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">Instigator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">GetEffectContext</span><span class="p">().</span><span class="n">GetEffectCauser</span><span class="p">();</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">InstigatorTags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">CapturedSourceTags</span><span class="p">.</span><span class="n">GetAggregatedTags</span><span class="p">();</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetOwningActor</span><span class="p">();</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">TargetTags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">.</span><span class="n">CapturedTargetTags</span><span class="p">.</span><span class="n">GetAggregatedTags</span><span class="p">();</span>
<span class="w">          </span><span class="c1">//@TODO: Fill out context tags, and any non-ability-system source/instigator tags</span>
<span class="w">          </span><span class="c1">//@TODO: Determine if it&#39;s an opposing team kill, self-own, team kill, etc...</span>
<span class="w">          </span><span class="n">Message</span><span class="p">.</span><span class="n">Magnitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="p">;</span>

<span class="w">          </span><span class="n">UGameplayMessageSubsystem</span><span class="o">&amp;</span><span class="w"> </span><span class="n">MessageSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UGameplayMessageSubsystem</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">());</span>
<span class="w">          </span><span class="n">MessageSystem</span><span class="p">.</span><span class="n">BroadcastMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="n">Verb</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="c1">// Convert into -Health and then clamp</span>
<span class="w">       </span><span class="n">SetHealth</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GetDamage</span><span class="p">(),</span><span class="w"> </span><span class="n">MinimumHealth</span><span class="p">,</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">()));</span>
<span class="w">       </span><span class="n">SetDamage</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetHealingAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Convert into +Health and then clamp</span>
<span class="w">       </span><span class="n">SetHealth</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">GetHealing</span><span class="p">(),</span><span class="w"> </span><span class="n">MinimumHealth</span><span class="p">,</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">()));</span>
<span class="w">       </span><span class="n">SetHealing</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetHealthAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Clamp and fall into out of health handling below</span>
<span class="w">       </span><span class="n">SetHealth</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">GetHealth</span><span class="p">(),</span><span class="w"> </span><span class="n">MinimumHealth</span><span class="p">,</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">()));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetMaxHealthAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// TODO clamp current health?</span>

<span class="w">       </span><span class="c1">// Notify on any requested max health changes</span>
<span class="w">       </span><span class="n">OnMaxHealthChanged</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Instigator</span><span class="p">,</span><span class="w"> </span><span class="n">Causer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="p">,</span><span class="w"> </span><span class="n">MaxHealthBeforeAttributeChange</span><span class="p">,</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If health has actually changed activate callbacks</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HealthBeforeAttributeChange</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">OnHealthChanged</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Instigator</span><span class="p">,</span><span class="w"> </span><span class="n">Causer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="p">,</span><span class="w"> </span><span class="n">HealthBeforeAttributeChange</span><span class="p">,</span><span class="w"> </span><span class="n">GetHealth</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">bOutOfHealth</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">OnOutOfHealth</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Instigator</span><span class="p">,</span><span class="w"> </span><span class="n">Causer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Data</span><span class="p">.</span><span class="n">EffectSpec</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">.</span><span class="n">EvaluatedData</span><span class="p">.</span><span class="n">Magnitude</span><span class="p">,</span><span class="w"> </span><span class="n">HealthBeforeAttributeChange</span><span class="p">,</span><span class="w"> </span><span class="n">GetHealth</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check health again in case an event above changed it.</span>
<span class="w">    </span><span class="n">bOutOfHealth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>​   PostGameplayEffectExecute中首先比较常规的是进行了夹值保证Attribute（就是Health）不会超出不合理的范围。由于HealthSet用到了MetaAttribute来作为中间值，所以实际上Health的改变量是由Damage和Healing在夹值Clamp中去实际进行的，每次用完Healing和Damage去修改Health之后就会把它们Reset成0，这一点注释很简单地指出来了。</p>
<p>​   PostGameplayEffect中很聪明的一点在于通过比较GameplayEffect应用前后的Health是否相等（通过缓存的HealthBeforeAttributeChange和GetHealth()进行比较），来决定是否要广播Health的改变，这就和通过FOnGameplayAttributeValueChange只要Attribute受到改变就会进行广播的广播方式有点不同。</p>
<p>​   </p>
<p>​   剩下几个函数随便看看即可，问题不大，主要是进行一些夹值避免出bug。</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHealthSet::PreAttributeBaseChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">PreAttributeBaseChange</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>

<span class="w">    </span><span class="n">ClampAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHealthSet::PreAttributeChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">PreAttributeChange</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>

<span class="w">    </span><span class="n">ClampAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHealthSet::PostAttributeChange</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">PostAttributeChange</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetMaxHealthAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Make sure current health is not greater than the new max health.</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetLyraAbilitySystemComponent</span><span class="p">();</span>
<span class="w">          </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ApplyModToAttribute</span><span class="p">(</span><span class="n">GetHealthAttribute</span><span class="p">(),</span><span class="w"> </span><span class="n">EGameplayModOp</span><span class="o">::</span><span class="n">Override</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bOutOfHealth</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">bOutOfHealth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHealthSet::ClampAttribute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttribute</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Attribute</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewValue</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetHealthAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Do not allow health to go negative or above max health.</span>
<span class="w">       </span><span class="n">NewValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">NewValue</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Attribute</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GetMaxHealthAttribute</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Do not allow max health to drop below 1.</span>
<span class="w">       </span><span class="n">NewValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FMath</span><span class="o">::</span><span class="n">Max</span><span class="p">(</span><span class="n">NewValue</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   Lyra的HealthSet基本上就是用于管理Lyra的生命值机制的逻辑，我们检查OnHealthChanged的用法，可以发现它在<strong>LyraHealthComponent</strong>中进行了回调函数的绑定，而这个组件就专门用来处理Lyra中Character的Health的变化的事件以及LyraCharacter死亡的事件，接下来我们继续沿着这条路线往下，看看Lyra是如何处理HealthAttribute的变化的展示的。</p>
<h5 id="121-healthcomponent">1.2.1 HealthComponent</h5>
<p>​   <strong>HealthSet</strong>的OnHealthChanged委托的<strong>回调函数的绑定</strong>的时机在ULyraHealthComponent::InitializeWithAbilitySystem中，这个就是一个HealthComponent的初始化的地方，而这个函数的唯一的调用时机是在LyraCharacter中，可知这个Component是挂在LyraCharacter上的，也确实合理，毕竟Character死了之后Health的展示也无从谈起了。InitializeWithAbilitySystem这个函数的调用比较地神奇，没看懂在干嘛，反正大概就是在Character上的ASC指针绑定了指向到PlayerState上的正统ASC之后，LyraCharacter就有了一个有效的ASC，然后就可以对HealthComponent进行安全的初始化。</p>
<p>LyraCharacter中的HealthComponent成员：</p>
<p><img alt="image-20250130010652663" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130010652663.png" /></p>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Components/GameFrameworkComponent.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraHealthComponent.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ULyraHealthComponent</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySystemComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraHealthSet</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayEffectSpec</span><span class="p">;</span>

<span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FLyraHealth_DeathEvent</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">OwningActor</span><span class="p">);</span>
<span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_FourParams</span><span class="p">(</span><span class="n">FLyraHealth_AttributeChanged</span><span class="p">,</span><span class="w"> </span><span class="n">ULyraHealthComponent</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">HealthComponent</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="n">NewValue</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Instigator</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ELyraDeathState</span>
<span class="cm"> *</span>
<span class="cm"> *  Defines current state of death.</span>
<span class="cm"> */</span>
<span class="n">UENUM</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ELyraDeathState</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">uint8</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NotDead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">DeathStarted</span><span class="p">,</span>
<span class="w">    </span><span class="n">DeathFinished</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraHealthComponent</span>
<span class="cm"> *</span>
<span class="cm"> *  An actor component used to handle anything related to health.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">Blueprintable</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="o">=</span><span class="p">(</span><span class="n">BlueprintSpawnableComponent</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraHealthComponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UGameFrameworkComponent</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraHealthComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Returns the health component if one exists on the specified actor.</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintPure</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">ULyraHealthComponent</span><span class="o">*</span><span class="w"> </span><span class="n">FindHealthComponent</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">Actor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Actor</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Actor</span><span class="o">-&gt;</span><span class="n">FindComponentByClass</span><span class="o">&lt;</span><span class="n">ULyraHealthComponent</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialize the component using an ability system component.</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">InitializeWithAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">InASC</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Uninitialize the component, clearing any references to the ability system.</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">UninitializeFromAbilitySystem</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Returns the current health value.</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">GetHealth</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Returns the current maximum health value.</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">GetMaxHealth</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Returns the current health in the range [0.0, 1.0].</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">GetHealthNormalized</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">ELyraDeathState</span><span class="w"> </span><span class="n">GetDeathState</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">DeathState</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintPure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Health&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ExpandBoolAsExecs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ReturnValue&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsDeadOrDying</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">DeathState</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ELyraDeathState</span><span class="o">::</span><span class="n">NotDead</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Begins the death sequence for the owner.</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">StartDeath</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Ends the death sequence for the owner.</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">FinishDeath</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Applies enough damage to kill the owner.</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DamageSelfDestruct</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">bFellOutOfWorld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Delegate fired when the health value has changed. This is called on the client but the instigator may not be valid</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintAssignable</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraHealth_AttributeChanged</span><span class="w"> </span><span class="n">OnHealthChanged</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Delegate fired when the max health value has changed. This is called on the client but the instigator may not be valid</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintAssignable</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraHealth_AttributeChanged</span><span class="w"> </span><span class="n">OnMaxHealthChanged</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Delegate fired when the death sequence has started.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintAssignable</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraHealth_DeathEvent</span><span class="w"> </span><span class="n">OnDeathStarted</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Delegate fired when the death sequence has finished.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintAssignable</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraHealth_DeathEvent</span><span class="w"> </span><span class="n">OnDeathFinished</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OnUnregister</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ClearGameplayTags</span><span class="p">();</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">HandleHealthChanged</span><span class="p">(</span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageInstigator</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageCauser</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectSpec</span><span class="o">*</span><span class="w"> </span><span class="n">DamageEffectSpec</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">DamageMagnitude</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">HandleMaxHealthChanged</span><span class="p">(</span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageInstigator</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageCauser</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectSpec</span><span class="o">*</span><span class="w"> </span><span class="n">DamageEffectSpec</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">DamageMagnitude</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">HandleOutOfHealth</span><span class="p">(</span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageInstigator</span><span class="p">,</span><span class="w"> </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">DamageCauser</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEffectSpec</span><span class="o">*</span><span class="w"> </span><span class="n">DamageEffectSpec</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">DamageMagnitude</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">OldValue</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">NewValue</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_DeathState</span><span class="p">(</span><span class="n">ELyraDeathState</span><span class="w"> </span><span class="n">OldDeathState</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Ability system used by this component.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AbilitySystemComponent</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Health set used by this component.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraHealthSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">HealthSet</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Replicated state used to handle dying.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">ReplicatedUsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnRep_DeathState</span><span class="p">)</span>
<span class="w">    </span><span class="n">ELyraDeathState</span><span class="w"> </span><span class="n">DeathState</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   阅读HealthComponent的代码，其实可以发现它就像是MVC设计模式中Controller的角色，充当了Model和View之间的中间层，但是它不仅仅对View表现Health变化负责，它还涉及到了对Character死亡的逻辑负责。其中可以看到它使用了HandleHealthChanged等命名规律一样的函数来转发HealthSet中的Health相关的改变，而HealthSet中的OnHealthChanged广播的HealthChange的一个监听者就是W_HealthBar，直接就是负责Health的直观显示，但是实际上Lyra为了实现一个效果很好的GhostProgressBar其实HealthBar没有用ProgressBar，而是用了<strong>材质实例+Widget动画</strong>，这也是个不错的思路。Lyra没有派生自己的Widget基类，Lyra和Aura不同之处在于Aura是用了WidgetController的思路，而Lyra是用了一个Component的思路。</p>
<p>​   LyraHealthComponent基本上就是这些内容，接下来再来看一下另一个AttributeSet——CombatSet。</p>
<h4 id="13-combatset">1.3 CombatSet</h4>
<p>​   通过查找用法，可以发现CombatSet出现在PlayState中作为一个属性，就和HealthSet一样。</p>
<p><img alt="image-20250130104548353" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130104548353.png" /></p>
<p>​   此时可以注意到<strong>PlayerState中</strong>的初始化ASC、HealthSet和CombatSet，PlayerState中也有很多的重要的信息，待会我们再看。</p>
<div class="highlight"><pre><span></span><code><span class="n">ALyraPlayerState</span><span class="o">::</span><span class="n">ALyraPlayerState</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">MyPlayerConnectionType</span><span class="p">(</span><span class="n">ELyraPlayerConnectionType</span><span class="o">::</span><span class="n">Player</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">AbilitySystemComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">.</span><span class="n">CreateDefaultSubobject</span><span class="o">&lt;</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;AbilitySystemComponent&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">AbilitySystemComponent</span><span class="o">-&gt;</span><span class="n">SetIsReplicated</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">AbilitySystemComponent</span><span class="o">-&gt;</span><span class="n">SetReplicationMode</span><span class="p">(</span><span class="n">EGameplayEffectReplicationMode</span><span class="o">::</span><span class="n">Mixed</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// These attribute sets will be detected by AbilitySystemComponent::InitializeComponent. Keeping a reference so that the sets don&#39;t get garbage collected before that.</span>
<span class="w">    </span><span class="n">HealthSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateDefaultSubobject</span><span class="o">&lt;</span><span class="n">ULyraHealthSet</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;HealthSet&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">CombatSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateDefaultSubobject</span><span class="o">&lt;</span><span class="n">ULyraCombatSet</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;CombatSet&quot;</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// AbilitySystemComponent needs to be updated at a high frequency.</span>
<span class="w">    </span><span class="n">SetNetUpdateFrequency</span><span class="p">(</span><span class="mf">100.0f</span><span class="p">);</span>

<span class="w">    </span><span class="n">MyTeamID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FGenericTeamId</span><span class="o">::</span><span class="n">NoTeam</span><span class="p">;</span>
<span class="w">    </span><span class="n">MySquadID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   可以看到初始化AttributeSet的时候上面的注释提示说，ASC会自己去找到AttributeSet，所以无需自己设置依赖，这是不错的。</p>
<p>​   CombatSet的内容相当简单：</p>
<p>.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystemComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAttributeSet.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraCombatSet.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraCombatSet</span>
<span class="cm"> *</span>
<span class="cm"> *  Class that defines attributes that are necessary for applying damage or healing.</span>
<span class="cm"> *  Attribute examples include: damage, healing, attack power, and shield penetrations.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraCombatSet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ULyraAttributeSet</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraCombatSet</span><span class="p">();</span>

<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseDamage</span><span class="p">);</span>
<span class="w">    </span><span class="n">ATTRIBUTE_ACCESSORS</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseHeal</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_BaseDamage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">()</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnRep_BaseHeal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// The base amount of damage to apply in the damage execution.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">ReplicatedUsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnRep_BaseDamage</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Combat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AllowPrivateAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">BaseDamage</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The base amount of healing to apply in the heal execution.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">ReplicatedUsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnRep_BaseHeal</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Combat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AllowPrivateAccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayAttributeData</span><span class="w"> </span><span class="n">BaseHeal</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>.cpp</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraCombatSet.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystem/Attributes/LyraAttributeSet.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Net/UnrealNetwork.h&quot;</span>

<span class="cp">#include UE_INLINE_GENERATED_CPP_BY_NAME(LyraCombatSet)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FLifetimeProperty</span><span class="p">;</span>


<span class="n">ULyraCombatSet</span><span class="o">::</span><span class="n">ULyraCombatSet</span><span class="p">()</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">BaseDamage</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">BaseHeal</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraCombatSet</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLifetimeProperty</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">OutLifetimeProps</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>

<span class="w">    </span><span class="n">DOREPLIFETIME_CONDITION_NOTIFY</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseDamage</span><span class="p">,</span><span class="w"> </span><span class="n">COND_OwnerOnly</span><span class="p">,</span><span class="w"> </span><span class="n">REPNOTIFY_Always</span><span class="p">);</span>
<span class="w">    </span><span class="n">DOREPLIFETIME_CONDITION_NOTIFY</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseHeal</span><span class="p">,</span><span class="w"> </span><span class="n">COND_OwnerOnly</span><span class="p">,</span><span class="w"> </span><span class="n">REPNOTIFY_Always</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraCombatSet</span><span class="o">::</span><span class="n">OnRep_BaseDamage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GAMEPLAYATTRIBUTE_REPNOTIFY</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseDamage</span><span class="p">,</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraCombatSet</span><span class="o">::</span><span class="n">OnRep_BaseHeal</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAttributeData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OldValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GAMEPLAYATTRIBUTE_REPNOTIFY</span><span class="p">(</span><span class="n">ULyraCombatSet</span><span class="p">,</span><span class="w"> </span><span class="n">BaseHeal</span><span class="p">,</span><span class="w"> </span><span class="n">OldValue</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>​   CombatSet中的Attribute主要用在<strong>进行GE的计算</strong>时使用，其中的Damage出现在Lyra的LyraDamageExecution中，这是一个GE的Execution计算类，Execution和MMC很类似，但是Execution有不同之处在于它可以修改多个Attributes，MMC属于Modifier，但Execution就是自己Execution在LyraDamageExecution中，CombatSet中的Damage被用于作为基础伤害，进行了涉及随距离的伤害衰减等参数运算后输出为最终的单次攻击的伤害：</p>
<p><img alt="image-20250130112600633" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130112600633.png" /></p>
<p>​   BTW：再往下深扒LyraRangedWeapon的造成伤害的逻辑，发现它本质上其实就是在激活GA_Weapon_Fire_SpecificWeapon（特定的一个武器的射击GA）用<strong>射线检测</strong>去获取射击命中的目标（这是写在GA_Weapon_Fire的C++基类LyraGameplayAbilityRangedWeapon中C++内部完成的东西，实际上不仅仅只是射线检测那么简单，还涉及到了子弹散布等判定），然后把特定武器继承自GA_Weapon_Fire这个GA的特定中的一个GE成员变量在该武器中设置的默认值（GE_Damage）Apply给<strong>命中的目标</strong>。例如这是Pistol的GE_Damage。</p>
<p><img alt="image-20250130113803749" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130113803749.png" /></p>
<p>​   Lyra的GE有一定的派生关系，但是Lyra只是从GAS原来的GameplayEffect中派生出自己的蓝图的GE，并没有去自己多派生一层给GE多增加东西，主要的意义是可以制作一些基类，相同类型的GE有部分相同的GameplayTag和持续时间策略，例如Pistol和Shootgun等等远程武器有共享的一些Tag，以及GE的持续时间策略都是Instant，这样做方便管理本质同类的GE并且可以复用一些设置：</p>
<p>GameplayEffectParent_Damage_Basic（继承自GameplayEffect）的设置：</p>
<p><img alt="image-20250130115739528" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130115739528.png" /></p>
<p>GE_Damage_Basic_Instant（继承自上面这个GE）</p>
<p><img alt="image-20250130115959289" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130115959289.png" /></p>
<blockquote>
<p>[!WARNING]</p>
<p>​ 我找了半天也没找到Lyra在游戏中是如何修改Character的BaseDamage和BaseHeal的，打开Debug AbilitySystem一看也发现都是0，但是这样的话怎么造成伤害？？？</p>
<p>[!NOTE]</p>
<p>​ 以上问题已解决，原来是直接在GE中定义的，Weapon的GE会在开火的时候直接把一个float值加给Character的CombatSet中的BaseDamage，这样就使得Character只有在进行攻击时才会有BaseDamage……有点神奇的思路只能说。像这里可以看到Pistol的GE_Damage_Pistol就在对目标造成伤害的时候给攻击的发起者了一个BaseDamage的瞬时的添加，使得攻击的发起者可以用Pistol造成18的伤害。</p>
</blockquote>
<p><img alt="image-20250130181239731" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250130181239731.png" /></p>
<h2 id="part-iii-lyrainput">PART III LyraInput系统</h2>
<h3 id="1-inputconfig">1. InputConfig</h3>
<p>​   Lyra的Input设计得很有意思，InputAction会和一个InputTag（其实是一个FGameplayTag）进行绑定，绑定的信息在DataAsset——LyraInputConfig中通过两个数组来定义。这两个数组的元素都是结构体FLyraInputAction</p>
<p>LyraInputConfig.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Engine/DataAsset.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameplayTagContainer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInputConfig.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UInputAction</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * FLyraInputAction</span>
<span class="cm"> *</span>
<span class="cm"> *  Struct used to map a input action to a gameplay input tag.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraInputAction</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">UInputAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputAction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;InputTag&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InputTag</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ULyraInputConfig</span>
<span class="cm"> *</span>
<span class="cm"> *  Non-mutable data asset that contains input configuration properties.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInputConfig</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UDataAsset</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraInputConfig</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Pawn&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">UInputAction</span><span class="o">*</span><span class="w"> </span><span class="n">FindNativeInputActionForTag</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bLogNotFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Pawn&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">UInputAction</span><span class="o">*</span><span class="w"> </span><span class="n">FindAbilityInputActionForTag</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bLogNotFound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// List of input actions used by the owner.  These input actions are mapped to a gameplay tag and must be manually bound.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TitleProperty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;InputAction&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraInputAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">NativeInputActions</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// List of input actions used by the owner.  These input actions are mapped to a gameplay tag and are automatically bound to abilities with matching input tags.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TitleProperty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;InputAction&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraInputAction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AbilityInputActions</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   看这两个数组，NativeInputAction管的是那些不需要做成Ability的那些行为，例如Character的Move；而AbilityInputActions管的是那些做成了Ability的行为，例如Fire。这点只要打开InputData_Hero就一目了然了：</p>
<p><img alt="image-20250131000453131" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131000453131.png" /></p>
<p>​   而且不难发现，Lyra的部分IA的命名和InputTag的命名的规律是一样的，遵循了相同的层级结构。除了像Jump、Weapon相关的IA。</p>
<p>​   我们不难找出其他的InputConfig，不同的InputConfig中给出了不同的LyraInputAction，通过给Character配置不同的InputConfig，就能实现指定Character被许可进行的有效的InputAction。</p>
<p>​   简单看下InputConfig的cpp，就是给出了两种依据InputTag找出TArray中对应的InputAction的方法。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraInputConfig.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraLogChannels.h&quot;</span>

<span class="cp">#include UE_INLINE_GENERATED_CPP_BY_NAME(LyraInputConfig)</span>


<span class="n">ULyraInputConfig</span><span class="o">::</span><span class="n">ULyraInputConfig</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">UInputAction</span><span class="o">*</span><span class="w"> </span><span class="n">ULyraInputConfig</span><span class="o">::</span><span class="n">FindNativeInputActionForTag</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bLogNotFound</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FLyraInputAction</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Action</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">NativeInputActions</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Action</span><span class="p">.</span><span class="n">InputAction</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Action</span><span class="p">.</span><span class="n">InputTag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">InputTag</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">InputAction</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bLogNotFound</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyra</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Can&#39;t find NativeInputAction for InputTag [%s] on InputConfig [%s].&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">InputTag</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span><span class="w"> </span><span class="n">UInputAction</span><span class="o">*</span><span class="w"> </span><span class="n">ULyraInputConfig</span><span class="o">::</span><span class="n">FindAbilityInputActionForTag</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bLogNotFound</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FLyraInputAction</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Action</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AbilityInputActions</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Action</span><span class="p">.</span><span class="n">InputAction</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Action</span><span class="p">.</span><span class="n">InputTag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">InputTag</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Action</span><span class="p">.</span><span class="n">InputAction</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bLogNotFound</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyra</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Can&#39;t find AbilityInputAction for InputTag [%s] on InputConfig [%s].&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">InputTag</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="11-inputconfiglyrapawndata">1.1 InputConfig和LyraPawnData</h4>
<p>​   InputConfig在LyraPawnData中被使用，PawnData主要维护了几个和LyraPawn有关的字段，直接看.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Engine/DataAsset.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraPawnData.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APawn</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySet</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilityTagRelationshipMapping</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraCameraMode</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraInputConfig</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraPawnData</span>
<span class="cm"> *</span>
<span class="cm"> *  Non-mutable data asset that contains properties used to define a pawn.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra Pawn Data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ShortTooltip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Data asset used to define a Pawn.&quot;</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LYRAGAME_API</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPrimaryDataAsset</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraPawnData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">);</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Class to instantiate for this pawn (should usually derive from ALyraPawn or ALyraCharacter).</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Pawn&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PawnClass</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Ability sets to grant to this pawn&#39;s ability system.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Abilities&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraAbilitySet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">AbilitySets</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// What mapping of ability tags to use for actions taking by this pawn</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Abilities&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraAbilityTagRelationshipMapping</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TagRelationshipMapping</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Input configuration used by player controlled pawns to create input mappings and bind input actions.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Input&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraInputConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputConfig</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Default camera mode used by player controlled pawns.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Lyra|Camera&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraCameraMode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DefaultCameraMode</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   LyraPawnData应该是用来初始化Pawn的信息，它派生自PrimaryDataAsset，可以派生蓝图类，其中一个字段AbilitySet中涉及到了要授予Pawn的GameplayAbilities以及GameplayEffects和AttributeSet，可见LyraPawnData和Lyra中的Character的初始化息息相关。</p>
<p>​   再细究PawnData的用处，通过在Rider中查找PawnData的用法，可以发现PawnData出现在了很多的类中，例如LyraPlayerState、LyraExperienceDefinition、LyraPawnExtensionComponent中都有PawnData的一个指针成员变量。</p>
<h5 id="111-lyrapawndata">1.1.1 LyraPawnData的起源</h5>
<p>​   经过一番苦苦追寻，我终于发现了LyraPawnData起源自LyraExperienceDefinition，Lyra中的Experience有点像是游戏的部分规则，它是一个PrimaryDataAsset的子类，以下是它的.h：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Engine/DataAsset.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraExperienceDefinition.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UGameFeatureAction</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraPawnData</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraExperienceActionSet</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Definition of an experience</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraExperienceDefinition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPrimaryDataAsset</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ULyraExperienceDefinition</span><span class="p">();</span>

<span class="w">    </span><span class="c1">//~UObject interface</span>
<span class="cp">#if WITH_EDITOR</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">EDataValidationResult</span><span class="w"> </span><span class="nf">IsDataValid</span><span class="p">(</span><span class="k">class</span><span class="w"> </span><span class="nc">FDataValidationContext</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">//~End of UObject interface</span>

<span class="w">    </span><span class="c1">//~UPrimaryDataAsset interface</span>
<span class="cp">#if WITH_EDITORONLY_DATA</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">UpdateAssetBundleData</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">//~End of UPrimaryDataAsset interface</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// List of Game Feature Plugins this experience wants to have active</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Gameplay</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FString</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GameFeaturesToEnable</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** The default pawn class to spawn for players */</span>
<span class="w">    </span><span class="c1">//@TODO: Make soft?</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Gameplay</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DefaultPawnData</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// List of actions to perform as this experience is loaded/activated/deactivated/unloaded</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Instanced</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Actions&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UGameFeatureAction</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Actions</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// List of additional action sets to compose into this experience</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="n">Gameplay</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraExperienceActionSet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ActionSets</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   Lyra会先在PlayerState中几乎算是初始化的地方试图为PlayerState根据一个给定的LyraExperienceDefinition中的DefaultPanwData去初始化PlayerState中的PawnData指针。具体的有关逻辑如下：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ALyraPlayerState::OnExperienceLoaded</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraExperienceDefinition</span><span class="o">*</span><span class="w"> </span><span class="cm">/*CurrentExperience*/</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraGameMode</span><span class="o">*</span><span class="w"> </span><span class="n">LyraGameMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAuthGameMode</span><span class="o">&lt;</span><span class="n">ALyraGameMode</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">*</span><span class="w"> </span><span class="n">NewPawnData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraGameMode</span><span class="o">-&gt;</span><span class="n">GetPawnDataForController</span><span class="p">(</span><span class="n">GetOwningController</span><span class="p">()))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">SetPawnData</span><span class="p">(</span><span class="n">NewPawnData</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">       </span><span class="k">else</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyra</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;ALyraPlayerState::OnExperienceLoaded(): Unable to find PawnData to initialize player state [%s]!&quot;</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   首先当ExperienceLoaded的时候，会初始化PlayerState中的PawnData，这里看似是通过GameMode从Controller获得PawnData的信息，实际上此时这两个人自己的PawnData指针都没初始化，Controller的PawnData都是来自于PlayerState，其实这里是采取了PlayerState上不存在PawnData就去问ExperienceDefinition要的逻辑。说实话这个套娃逻辑某种程度上来说有点抽象。这里的ExperienceLoad的逻辑比较复杂，就暂且当作是游戏准备开始的事前准备就ok了。</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">*</span><span class="w"> </span><span class="nf">ALyraGameMode::GetPawnDataForController</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AController</span><span class="o">*</span><span class="w"> </span><span class="n">InController</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// See if pawn data is already set on the player state</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InController</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ALyraPlayerState</span><span class="o">*</span><span class="w"> </span><span class="n">LyraPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InController</span><span class="o">-&gt;</span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">ALyraPlayerState</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">*</span><span class="w"> </span><span class="n">PawnData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraPS</span><span class="o">-&gt;</span><span class="n">GetPawnData</span><span class="o">&lt;</span><span class="n">ULyraPawnData</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">return</span><span class="w"> </span><span class="n">PawnData</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// If not, fall back to the the default for the current experience</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">GameState</span><span class="p">);</span>
<span class="w">    </span><span class="n">ULyraExperienceManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="n">ExperienceComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GameState</span><span class="o">-&gt;</span><span class="n">FindComponentByClass</span><span class="o">&lt;</span><span class="n">ULyraExperienceManagerComponent</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">ExperienceComponent</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ExperienceComponent</span><span class="o">-&gt;</span><span class="n">IsExperienceLoaded</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraExperienceDefinition</span><span class="o">*</span><span class="w"> </span><span class="n">Experience</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExperienceComponent</span><span class="o">-&gt;</span><span class="n">GetCurrentExperienceChecked</span><span class="p">();</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Experience</span><span class="o">-&gt;</span><span class="n">DefaultPawnData</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">Experience</span><span class="o">-&gt;</span><span class="n">DefaultPawnData</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="c1">// Experience is loaded and there&#39;s still no pawn data, fall back to the default for now</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">ULyraAssetManager</span><span class="o">::</span><span class="n">Get</span><span class="p">().</span><span class="n">GetDefaultPawnData</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Experience not loaded yet, so there is no pawn data to be had</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>​   当PlayerState拿到当前的ExperienceDefinition所设置的PawnData后，它就相当于一个拥有PawnData的代言人了，接下来我们再去找PawnData在哪里被用来初始化Character的输入逻辑也就是PawnData的InputConfig在哪里被使用来初始化了，这是我们最关心的。</p>
<h5 id="112-lyrapawndata">1.1.2 LyraPawnData如何发挥作用</h5>
<p>​   我又一路追溯来到了LyraHeroComponent，终于发现了PawnData用于初始化Character的地方，就是在此：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::HandleChangeInitState</span><span class="p">(</span><span class="n">UGameFrameworkComponentManager</span><span class="o">*</span><span class="w"> </span><span class="n">Manager</span><span class="p">,</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">CurrentState</span><span class="p">,</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">DesiredState</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InitState_DataAvailable</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">DesiredState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InitState_DataInitialized</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="n">ALyraPlayerState</span><span class="o">*</span><span class="w"> </span><span class="n">LyraPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">ALyraPlayerState</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ensure</span><span class="p">(</span><span class="n">Pawn</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">LyraPS</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">*</span><span class="w"> </span><span class="n">PawnData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraPawnExtensionComponent</span><span class="o">*</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">::</span><span class="n">FindPawnExtensionComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">PawnData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="o">-&gt;</span><span class="n">GetPawnData</span><span class="o">&lt;</span><span class="n">ULyraPawnData</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">          </span><span class="c1">// The player state holds the persistent data for this player (state that persists across deaths and multiple pawns).</span>
<span class="w">          </span><span class="c1">// The ability system component and attribute sets live on the player state.</span>
<span class="w">          </span><span class="n">PawnExtComp</span><span class="o">-&gt;</span><span class="n">InitializeAbilitySystem</span><span class="p">(</span><span class="n">LyraPS</span><span class="o">-&gt;</span><span class="n">GetLyraAbilitySystemComponent</span><span class="p">(),</span><span class="w"> </span><span class="n">LyraPS</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraPlayerController</span><span class="o">*</span><span class="w"> </span><span class="n">LyraPC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetController</span><span class="o">&lt;</span><span class="n">ALyraPlayerController</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">InputComponent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">InitializePlayerInput</span><span class="p">(</span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">InputComponent</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="c1">// Hook up the delegate for all pawns, in case we spectate later</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PawnData</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraCameraComponent</span><span class="o">*</span><span class="w"> </span><span class="n">CameraComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraCameraComponent</span><span class="o">::</span><span class="n">FindCameraComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">CameraComponent</span><span class="o">-&gt;</span><span class="n">DetermineCameraModeDelegate</span><span class="p">.</span><span class="n">BindUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">DetermineCameraMode</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   这里出现了一个很有意义的注释，这段注释道出了众多的信息。（这里稍微有点偏题了，注意力继续回到PawnConfig上！</p>
<div class="highlight"><pre><span></span><code><span class="c1">// The player state holds the persistent data for this player (state that persists across deaths and multiple pawns).</span>
<span class="w">          </span><span class="c1">// The ability system component and attribute sets live on the player state.</span>
</code></pre></div>
<p>​   我们注意到此时这里虽然出场了PawnData，但是PawnData中的InputConfig却没有出场，但是我们能注意到和InputConfig关系密切的InputComponent出现了！我们要接近答案了！！！</p>
<p><img alt="image-20250131011830762" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131011830762.png" /></p>
<h5 id="113-inputconfig">1.1.3 InputConfig的目的地</h5>
<p>​   可以看到这个InitializePlayerInput是HeroComponent的一个成员函数，它的名字预示着答案的降临！查看它的定义：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::InitializePlayerInput</span><span class="p">(</span><span class="n">UInputComponent</span><span class="o">*</span><span class="w"> </span><span class="n">PlayerInputComponent</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">PlayerInputComponent</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Pawn</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">APlayerController</span><span class="o">*</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetController</span><span class="o">&lt;</span><span class="n">APlayerController</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">PC</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraLocalPlayer</span><span class="o">*</span><span class="w"> </span><span class="n">LP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">ULyraLocalPlayer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PC</span><span class="o">-&gt;</span><span class="n">GetLocalPlayer</span><span class="p">());</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LP</span><span class="p">);</span>

<span class="w">    </span><span class="n">UEnhancedInputLocalPlayerSubsystem</span><span class="o">*</span><span class="w"> </span><span class="n">Subsystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LP</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">UEnhancedInputLocalPlayerSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">);</span>

<span class="w">    </span><span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">ClearAllMappings</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">*</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">::</span><span class="n">FindPawnExtensionComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnData</span><span class="o">*</span><span class="w"> </span><span class="n">PawnData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="o">-&gt;</span><span class="n">GetPawnData</span><span class="o">&lt;</span><span class="n">ULyraPawnData</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraInputConfig</span><span class="o">*</span><span class="w"> </span><span class="n">InputConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PawnData</span><span class="o">-&gt;</span><span class="n">InputConfig</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputMappingContextAndPriority</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Mapping</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">DefaultInputMappings</span><span class="p">)</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UInputMappingContext</span><span class="o">*</span><span class="w"> </span><span class="n">IMC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mapping</span><span class="p">.</span><span class="n">InputMapping</span><span class="p">.</span><span class="n">Get</span><span class="p">())</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Mapping</span><span class="p">.</span><span class="n">bRegisterWithSettings</span><span class="p">)</span>
<span class="w">                   </span><span class="p">{</span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UEnhancedInputUserSettings</span><span class="o">*</span><span class="w"> </span><span class="n">Settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetUserSettings</span><span class="p">())</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                         </span><span class="n">Settings</span><span class="o">-&gt;</span><span class="n">RegisterInputMappingContext</span><span class="p">(</span><span class="n">IMC</span><span class="p">);</span>
<span class="w">                      </span><span class="p">}</span>

<span class="w">                      </span><span class="n">FModifyContextOptions</span><span class="w"> </span><span class="n">Options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">                      </span><span class="n">Options</span><span class="p">.</span><span class="n">bIgnoreAllPressedKeysUntilRelease</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                      </span><span class="c1">// Actually add the config to the local player                   </span>
<span class="w">                      </span><span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">AddMappingContext</span><span class="p">(</span><span class="n">IMC</span><span class="p">,</span><span class="w"> </span><span class="n">Mapping</span><span class="p">.</span><span class="n">Priority</span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="p">);</span>
<span class="w">                   </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">             </span><span class="p">}</span>

<span class="w">             </span><span class="c1">// The Lyra Input Component has some additional functions to map Gameplay Tags to an Input Action.</span>
<span class="w">             </span><span class="c1">// If you want this functionality but still want to change your input component class, make it a subclass</span>
<span class="w">             </span><span class="c1">// of the ULyraInputComponent or modify this component accordingly.</span>
<span class="w">             </span><span class="n">ULyraInputComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraIC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">ULyraInputComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PlayerInputComponent</span><span class="p">);</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ensureMsgf</span><span class="p">(</span><span class="n">LyraIC</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;Unexpected Input Component class! The Gameplay Abilities will not be bound to their inputs. Change the input component to ULyraInputComponent or a subclass of it.&quot;</span><span class="p">)))</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Add the key mappings that may have been set by the player</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">AddInputMappings</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">Subsystem</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// This is where we actually bind and input action to a gameplay tag, which means that Gameplay Ability Blueprints will</span>
<span class="w">                </span><span class="c1">// be triggered directly by these input actions Triggered events. </span>
<span class="w">                </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint32</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BindHandles</span><span class="p">;</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindAbilityActions</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_AbilityInputTagPressed</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_AbilityInputTagReleased</span><span class="p">,</span><span class="w"> </span><span class="cm">/*out*/</span><span class="w"> </span><span class="n">BindHandles</span><span class="p">);</span>

<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindNativeAction</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InputTag_Move</span><span class="p">,</span><span class="w"> </span><span class="n">ETriggerEvent</span><span class="o">::</span><span class="n">Triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_Move</span><span class="p">,</span><span class="w"> </span><span class="cm">/*bLogIfNotFound=*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindNativeAction</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InputTag_Look_Mouse</span><span class="p">,</span><span class="w"> </span><span class="n">ETriggerEvent</span><span class="o">::</span><span class="n">Triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_LookMouse</span><span class="p">,</span><span class="w"> </span><span class="cm">/*bLogIfNotFound=*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindNativeAction</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InputTag_Look_Stick</span><span class="p">,</span><span class="w"> </span><span class="n">ETriggerEvent</span><span class="o">::</span><span class="n">Triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_LookStick</span><span class="p">,</span><span class="w"> </span><span class="cm">/*bLogIfNotFound=*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindNativeAction</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InputTag_Crouch</span><span class="p">,</span><span class="w"> </span><span class="n">ETriggerEvent</span><span class="o">::</span><span class="n">Triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_Crouch</span><span class="p">,</span><span class="w"> </span><span class="cm">/*bLogIfNotFound=*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">                </span><span class="n">LyraIC</span><span class="o">-&gt;</span><span class="n">BindNativeAction</span><span class="p">(</span><span class="n">InputConfig</span><span class="p">,</span><span class="w"> </span><span class="n">LyraGameplayTags</span><span class="o">::</span><span class="n">InputTag_AutoRun</span><span class="p">,</span><span class="w"> </span><span class="n">ETriggerEvent</span><span class="o">::</span><span class="n">Triggered</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">Input_AutoRun</span><span class="p">,</span><span class="w"> </span><span class="cm">/*bLogIfNotFound=*/</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ensure</span><span class="p">(</span><span class="o">!</span><span class="n">bReadyToBindInputs</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">bReadyToBindInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">UGameFrameworkComponentManager</span><span class="o">::</span><span class="n">SendGameFrameworkComponentExtensionEvent</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">APlayerController</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">PC</span><span class="p">),</span><span class="w"> </span><span class="n">NAME_BindInputsNow</span><span class="p">);</span>
<span class="w">    </span><span class="n">UGameFrameworkComponentManager</span><span class="o">::</span><span class="n">SendGameFrameworkComponentExtensionEvent</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">Pawn</span><span class="p">),</span><span class="w"> </span><span class="n">NAME_BindInputsNow</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>​   果然！我们终于见到了LyraInputComponent的InputAction绑定的回调函数，关注到这里的BindHandles，其实根本没有用到，不知道在干嘛（汗。这里的&amp;ThisClass::Input_AbilityInputTagPressed, &amp;ThisClass::Input_AbilityInputTagReleased，其实本质上就是在调用AbilitySystemComponent中已经定义好了的AbilityInputTagPressed和AbilityInputTagReleased：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_AbilityInputTagPressed</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InputTag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">*</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">::</span><span class="n">FindPawnExtensionComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="o">-&gt;</span><span class="n">GetLyraAbilitySystemComponent</span><span class="p">())</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">AbilityInputTagPressed</span><span class="p">(</span><span class="n">InputTag</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_AbilityInputTagReleased</span><span class="p">(</span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InputTag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Pawn</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">*</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraPawnExtensionComponent</span><span class="o">::</span><span class="n">FindPawnExtensionComponent</span><span class="p">(</span><span class="n">Pawn</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PawnExtComp</span><span class="o">-&gt;</span><span class="n">GetLyraAbilitySystemComponent</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">AbilityInputTagReleased</span><span class="p">(</span><span class="n">InputTag</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   此外还可以继续在LyraHeroComponent.cpp往下找，找到那些绑定NativeInputAction的函数：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_Move</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputActionValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">    </span><span class="n">AController</span><span class="o">*</span><span class="w"> </span><span class="n">Controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">GetController</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// If the player has attempted to move again then cancel auto running</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraPlayerController</span><span class="o">*</span><span class="w"> </span><span class="n">LyraController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">ALyraPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Controller</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">LyraController</span><span class="o">-&gt;</span><span class="n">SetIsAutoRunning</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FVector2D</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">FVector2D</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FRotator</span><span class="w"> </span><span class="n">MovementRotation</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span><span class="w"> </span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">GetControlRotation</span><span class="p">().</span><span class="n">Yaw</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">FVector</span><span class="w"> </span><span class="n">MovementDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MovementRotation</span><span class="p">.</span><span class="n">RotateVector</span><span class="p">(</span><span class="n">FVector</span><span class="o">::</span><span class="n">RightVector</span><span class="p">);</span>
<span class="w">          </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddMovementInput</span><span class="p">(</span><span class="n">MovementDirection</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">FVector</span><span class="w"> </span><span class="n">MovementDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MovementRotation</span><span class="p">.</span><span class="n">RotateVector</span><span class="p">(</span><span class="n">FVector</span><span class="o">::</span><span class="n">ForwardVector</span><span class="p">);</span>
<span class="w">          </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddMovementInput</span><span class="p">(</span><span class="n">MovementDirection</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_LookMouse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputActionValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Pawn</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FVector2D</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">FVector2D</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddControllerYawInput</span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddControllerPitchInput</span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_LookStick</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputActionValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">Pawn</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FVector2D</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">FVector2D</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">UWorld</span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">();</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">World</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddControllerYawInput</span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">X</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">LyraHero</span><span class="o">::</span><span class="n">LookYawRate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="o">-&gt;</span><span class="n">GetDeltaSeconds</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">AddControllerPitchInput</span><span class="p">(</span><span class="n">Value</span><span class="p">.</span><span class="n">Y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">LyraHero</span><span class="o">::</span><span class="n">LookPitchRate</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="o">-&gt;</span><span class="n">GetDeltaSeconds</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_Crouch</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputActionValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraCharacter</span><span class="o">*</span><span class="w"> </span><span class="n">Character</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">ALyraCharacter</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">Character</span><span class="o">-&gt;</span><span class="n">ToggleCrouch</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraHeroComponent::Input_AutoRun</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInputActionValue</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputActionValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">APawn</span><span class="o">*</span><span class="w"> </span><span class="n">Pawn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraPlayerController</span><span class="o">*</span><span class="w"> </span><span class="n">Controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">ALyraPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Pawn</span><span class="o">-&gt;</span><span class="n">GetController</span><span class="p">()))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="c1">// Toggle auto running</span>
<span class="w">          </span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SetIsAutoRunning</span><span class="p">(</span><span class="o">!</span><span class="n">Controller</span><span class="o">-&gt;</span><span class="n">GetIsAutoRunning</span><span class="p">());</span>
<span class="w">       </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   我们的注意力来到LyraAbilitySystemComponent中的AbilityInputTagPressed和AbilityInputTagReleased的实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraAbilitySystemComponent::AbilityInputTagPressed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InputTag</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">AbilitySpec</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ActivatableAbilities</span><span class="p">.</span><span class="n">Items</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Ability</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">GetDynamicSpecSourceTags</span><span class="p">().</span><span class="n">HasTagExact</span><span class="p">(</span><span class="n">InputTag</span><span class="p">)))</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">InputPressedSpecHandles</span><span class="p">.</span><span class="n">AddUnique</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">             </span><span class="n">InputHeldSpecHandles</span><span class="p">.</span><span class="n">AddUnique</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ULyraAbilitySystemComponent::AbilityInputTagReleased</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InputTag</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InputTag</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpec</span><span class="o">&amp;</span><span class="w"> </span><span class="n">AbilitySpec</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ActivatableAbilities</span><span class="p">.</span><span class="n">Items</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Ability</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">GetDynamicSpecSourceTags</span><span class="p">().</span><span class="n">HasTagExact</span><span class="p">(</span><span class="n">InputTag</span><span class="p">)))</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">InputReleasedSpecHandles</span><span class="p">.</span><span class="n">AddUnique</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">             </span><span class="n">InputHeldSpecHandles</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   我们会发现实际上它们俩是会去遍历本ASC中的可激活的Abilities，检查其DynamicAbilityTags中是否带有对应于输入的Tag，如果有，就把该AbilitySpec的Handle添加到或移除出InputHeldSpecHandles，并且把它们放在分别的两个存储Handles的数组中统一处理，这些AbilitySpecHandle的统一处理在另一个ASC的函数中，待会再看。    </p>
<blockquote>
<p>[!NOTE]</p>
<p>​ 实际上这个方法和在Aura中学到的其实是<strong>完全一样的</strong>，只不过Aura的教学版本是5.2，当时还是通过直接访问AbilitySpec.DynamicAbilityTgas,在5.5版本的Lyra中弃用了直接访问DynamicAbilityTags的做法转而采取使用一个Getter函数GetDynamicSpecSourseTags来间接访问它。</p>
</blockquote>
<p>​   现在我们知道了ASC有能力根据不同的InputTag的输入，去执行不同的GameplayAbility，但是这样的联系是如何做到的呢？我们在编辑器中先从<strong>InputData_Hero</strong>了解到InputTag.Weapon.Fire和IA_Weapon_Fire相关联，我们又搜索InputTag.Weapon.Fire的引用关系，发现它被唯一的GameplayAbility引用是被GA_WeaponFire，一切都对上了！！！</p>
<p><img alt="image-20250131110751153" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131110751153.png" /></p>
<p>​   它并不是出现在表面上的GA的各种Tag中，而是出现在了”触发器“中：</p>
<p><img alt="image-20250131111255550" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131111255550.png" /></p>
<h4 id="12-abilitysetinputtag">1.2 AbilitySet和InputTag的关联</h4>
<h5 id="121-inputtaggameplayability">1.2.1 InputTag与GameplayAbility的绑定之处</h5>
<p>​   但是！这并不是决定通过InputTag触发特定GameplayAbility的地方，取消这里的触发标签并不会影响你在Lyra中开枪。决定它们的响应关系的地方是在LyraAbilitySet中的GiveToAbilitySystem函数中！！！</p>
<p><img alt="image-20250131112350900" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131112350900.png" /></p>
<p>​   GiveToAbilitySystem函数的完整实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">ULyraAbilitySet::GiveToAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="o">*</span><span class="w"> </span><span class="n">OutGrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">UObject</span><span class="o">*</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">IsOwnerActorAuthoritative</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Must be authoritative to give or take ability sets.</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the attribute sets.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">SetIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_AttributeSet</span><span class="o">&amp;</span><span class="w"> </span><span class="n">SetToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">[</span><span class="n">SetIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedAttributes[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">SetIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">NewSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">(),</span><span class="w"> </span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">);</span>
<span class="w">       </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">AddAttributeSetSubobject</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAttributeSet</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay abilities.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">AbilityIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayAbility</span><span class="o">&amp;</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">[</span><span class="n">AbilityIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayAbilities[%d] on ability set [%s] is not valid.&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">ULyraGameplayAbility</span><span class="o">*</span><span class="w"> </span><span class="n">AbilityCDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">ULyraGameplayAbility</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">       </span><span class="n">FGameplayAbilitySpec</span><span class="w"> </span><span class="n">AbilitySpec</span><span class="p">(</span><span class="n">AbilityCDO</span><span class="p">,</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">AbilityLevel</span><span class="p">);</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">SourceObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">;</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">GetDynamicSpecSourceTags</span><span class="p">().</span><span class="n">AddTag</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">InputTag</span><span class="p">);</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">AbilitySpecHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GiveAbility</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAbilitySpecHandle</span><span class="p">(</span><span class="n">AbilitySpecHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay effects.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">EffectIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayEffect</span><span class="o">&amp;</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">[</span><span class="n">EffectIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayEffects[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">EffectIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">UGameplayEffect</span><span class="o">*</span><span class="w"> </span><span class="n">GameplayEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">UGameplayEffect</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="w"> </span><span class="n">GameplayEffectHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ApplyGameplayEffectToSelf</span><span class="p">(</span><span class="n">GameplayEffect</span><span class="p">,</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">EffectLevel</span><span class="p">,</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">MakeEffectContext</span><span class="p">());</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddGameplayEffectHandle</span><span class="p">(</span><span class="n">GameplayEffectHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   在AbilitySet的GiveToAbilitySystem函数中出现了将AbilityToGrant.InputTag添加加给AbilitySpec的DynamicAbilityTags，这样就实现了把AbilitySet这个PrimaryDataAsset中存有的关于GAS的三大信息：Attribute，GameplayAbility，GameplayEffect给授予给了特定目标的ASC。</p>
<h4 id="13-abilityset">1.3 细探AbilitySet</h4>
<p>​   在这里，它不仅完成了InputTag到GameplayAbility的映射关系的初始化，还会把自身携带的GE Apply到目标ASC上，可见得Lyra在ASC交互上的巧思：Lyra通过AbilitySet定义了授予目标GA、GE和Attribute的内容，这样的话，一个AbilitySet既可以用来初始化一个单位，又可以让一个Item携带有一套AbilitySet，然后在被被装备的时候授予携带的内容给目标ASC。</p>
<p>​   我们可以看到其丰富的应用：</p>
<p><img alt="image-20250131114519381" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131114519381.png" /></p>
<p><img alt="image-20250131114610464" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131114610464.png" /></p>
<p><img alt="image-20250131114629184" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131114629184.png" /></p>
<p>​   在编辑器中查看Pistol携带的AbilitySet：</p>
<p><img alt="image-20250131114734301" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250131114734301.png" /></p>
<p>​   此外，AbilitySet中还定义了TakeFromAbilitySystem函数来处理自身被移除出ASC时的事情，但是这个函数实际上是属于结构体FLyraAbilitySet_GrantedHandles的，这个结构体是用来保存在赋予AbilitySet到ASC时授予出去的GA、GE、Attribute的一个结构体，我们再进一步了解一下它，后面直接上全部的代码：</p>
<p>FLyraAbilitySet_GrantedHandles::TakeFromAbilitySystem函数的定义：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">FLyraAbilitySet_GrantedHandles::TakeFromAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">IsOwnerActorAuthoritative</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Must be authoritative to give or take ability sets.</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AbilitySpecHandles</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ClearAbility</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameplayEffectHandles</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">RemoveActiveGameplayEffect</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GrantedAttributeSets</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">RemoveSpawnedAttribute</span><span class="p">(</span><span class="n">Set</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">AbilitySpecHandles</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">GameplayEffectHandles</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">GrantedAttributeSets</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>LyraAbilitySet.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ActiveGameplayEffectHandle.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Engine/DataAsset.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AttributeSet.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameplayTagContainer.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GameplayAbilitySpecHandle.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAbilitySet.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UAttributeSet</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UGameplayEffect</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySystemComponent</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraGameplayAbility</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>


<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GameplayAbility</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant gameplay abilities.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GameplayAbility</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay ability to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraGameplayAbility</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Ability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Level of ability to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">int32</span><span class="w"> </span><span class="n">AbilityLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Tag used to process input for the ability.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;InputTag&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="n">FGameplayTag</span><span class="w"> </span><span class="n">InputTag</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GameplayEffect</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant gameplay effects.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GameplayEffect</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">UGameplayEffect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GameplayEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Level of gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">EffectLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_AttributeSet</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used by the ability set to grant attribute sets.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_AttributeSet</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Gameplay effect to grant.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AttributeSet</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * FLyraAbilitySet_GrantedHandles</span>
<span class="cm"> *</span>
<span class="cm"> *  Data used to store handles to what has been granted by the ability set.</span>
<span class="cm"> */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAbilitySet_GrantedHandles</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddAbilitySpecHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddGameplayEffectHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddAttributeSet</span><span class="p">(</span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">Set</span><span class="p">);</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">TakeFromAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Handles to the granted abilities.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AbilitySpecHandles</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Handles to the granted gameplay effects.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GameplayEffectHandles</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Pointers to the granted attribute sets</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GrantedAttributeSets</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * ULyraAbilitySet</span>
<span class="cm"> *</span>
<span class="cm"> *  Non-mutable data asset used to grant gameplay abilities and gameplay effects.</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">,</span><span class="w"> </span><span class="n">Const</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraAbilitySet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UPrimaryDataAsset</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraAbilitySet</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// Grants the ability set to the specified ability system component.</span>
<span class="w">    </span><span class="c1">// The returned handles can be used later to take away anything that was granted.</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">GiveToAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="o">*</span><span class="w"> </span><span class="n">OutGrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">UObject</span><span class="o">*</span><span class="w"> </span><span class="n">SourceObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="c1">// Gameplay abilities to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Gameplay Abilities&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">Ability</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_GameplayAbility</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Gameplay effects to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Gameplay Effects&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">GameplayEffect</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_GameplayEffect</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Attribute sets to grant when this ability set is granted.</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Attribute Sets&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">TitleProperty</span><span class="o">=</span><span class="n">AttributeSet</span><span class="p">))</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLyraAbilitySet_AttributeSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>LyraAbilitySet.cpp</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAbilitySet.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystem/Abilities/LyraGameplayAbility.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraAbilitySystemComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraLogChannels.h&quot;</span>

<span class="cp">#include UE_INLINE_GENERATED_CPP_BY_NAME(LyraAbilitySet)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraAbilitySet_GrantedHandles::AddAbilitySpecHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">AbilitySpecHandles</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraAbilitySet_GrantedHandles::AddGameplayEffectHandle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">GameplayEffectHandles</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraAbilitySet_GrantedHandles::AddAttributeSet</span><span class="p">(</span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">Set</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GrantedAttributeSets</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Set</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraAbilitySet_GrantedHandles::TakeFromAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">IsOwnerActorAuthoritative</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Must be authoritative to give or take ability sets.</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">AbilitySpecHandles</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ClearAbility</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GameplayEffectHandles</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Handle</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">RemoveActiveGameplayEffect</span><span class="p">(</span><span class="n">Handle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">GrantedAttributeSets</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">RemoveSpawnedAttribute</span><span class="p">(</span><span class="n">Set</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">AbilitySpecHandles</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">GameplayEffectHandles</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="w">    </span><span class="n">GrantedAttributeSets</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">ULyraAbilitySet</span><span class="o">::</span><span class="n">ULyraAbilitySet</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraAbilitySet</span><span class="o">::</span><span class="n">GiveToAbilitySystem</span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">LyraASC</span><span class="p">,</span><span class="w"> </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="o">*</span><span class="w"> </span><span class="n">OutGrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">UObject</span><span class="o">*</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">LyraASC</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">IsOwnerActorAuthoritative</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">// Must be authoritative to give or take ability sets.</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the attribute sets.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">SetIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">SetIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_AttributeSet</span><span class="o">&amp;</span><span class="w"> </span><span class="n">SetToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedAttributes</span><span class="p">[</span><span class="n">SetIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedAttributes[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">SetIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">UAttributeSet</span><span class="o">*</span><span class="w"> </span><span class="n">NewSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">UAttributeSet</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">(),</span><span class="w"> </span><span class="n">SetToGrant</span><span class="p">.</span><span class="n">AttributeSet</span><span class="p">);</span>
<span class="w">       </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">AddAttributeSetSubobject</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAttributeSet</span><span class="p">(</span><span class="n">NewSet</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay abilities.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">AbilityIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayAbility</span><span class="o">&amp;</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayAbilities</span><span class="p">[</span><span class="n">AbilityIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayAbilities[%d] on ability set [%s] is not valid.&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">AbilityIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">ULyraGameplayAbility</span><span class="o">*</span><span class="w"> </span><span class="n">AbilityCDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">Ability</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">ULyraGameplayAbility</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">       </span><span class="n">FGameplayAbilitySpec</span><span class="w"> </span><span class="nf">AbilitySpec</span><span class="p">(</span><span class="n">AbilityCDO</span><span class="p">,</span><span class="w"> </span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">AbilityLevel</span><span class="p">);</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">SourceObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SourceObject</span><span class="p">;</span>
<span class="w">       </span><span class="n">AbilitySpec</span><span class="p">.</span><span class="n">GetDynamicSpecSourceTags</span><span class="p">().</span><span class="n">AddTag</span><span class="p">(</span><span class="n">AbilityToGrant</span><span class="p">.</span><span class="n">InputTag</span><span class="p">);</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">AbilitySpecHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">GiveAbility</span><span class="p">(</span><span class="n">AbilitySpec</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddAbilitySpecHandle</span><span class="p">(</span><span class="n">AbilitySpecHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Grant the gameplay effects.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">int32</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">EffectIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">EffectIndex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FLyraAbilitySet_GameplayEffect</span><span class="o">&amp;</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GrantedGameplayEffects</span><span class="p">[</span><span class="n">EffectIndex</span><span class="p">];</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogLyraAbilitySystem</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">TEXT</span><span class="p">(</span><span class="s">&quot;GrantedGameplayEffects[%d] on ability set [%s] is not valid&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">EffectIndex</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">GetNameSafe</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="w">          </span><span class="k">continue</span><span class="p">;</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">UGameplayEffect</span><span class="o">*</span><span class="w"> </span><span class="n">GameplayEffect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">GameplayEffect</span><span class="o">-&gt;</span><span class="n">GetDefaultObject</span><span class="o">&lt;</span><span class="n">UGameplayEffect</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FActiveGameplayEffectHandle</span><span class="w"> </span><span class="n">GameplayEffectHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">ApplyGameplayEffectToSelf</span><span class="p">(</span><span class="n">GameplayEffect</span><span class="p">,</span><span class="w"> </span><span class="n">EffectToGrant</span><span class="p">.</span><span class="n">EffectLevel</span><span class="p">,</span><span class="w"> </span><span class="n">LyraASC</span><span class="o">-&gt;</span><span class="n">MakeEffectContext</span><span class="p">());</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OutGrantedHandles</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutGrantedHandles</span><span class="o">-&gt;</span><span class="n">AddGameplayEffectHandle</span><span class="p">(</span><span class="n">GameplayEffectHandle</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="131-abilitysetequipmentdefinition">1.3.1 AbilitySet与EquipmentDefinition</h5>
<p>​   接着我们再查找GiveToAbilitySystem的用法，发现了它在EquipmentManagerComponent中的用法！正是在AddEntry中！！！当一件装备被装备上了之后，它的<strong>EquipmentDefinition</strong>上携带的AbilitySet（在EquipmentDefinition中被存在一个AbilitySet数组中，数组叫AbilitySetsToGrant）就会被授予它的装备者的ASC！并且Equipment的Entry中还有一个字段，就是一个FLyraAbilitySet_GrantedHandles，它保存了AbilitySet来时的路，保存了这件Equipment给予了目标ASC什么AbilitySet，以便后续可以在RemoveEntry中把AbilitySet带给ASC的影响<strong>取消掉</strong>。</p>
<p>​   来回顾一下EquipmentManagerComponent的AddEntry和RemoveEntry：（其实应该说是EquipmentList的函数）</p>
<div class="highlight"><pre><span></span><code><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="nf">FLyraEquipmentList::AddEntry</span><span class="p">(</span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">EquipmentDefinition</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="p">);</span>
<span class="w">    </span><span class="n">check</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">HasAuthority</span><span class="p">());</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">ULyraEquipmentDefinition</span><span class="o">*</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetDefault</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="p">(</span><span class="n">EquipmentDefinition</span><span class="p">);</span>

<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InstanceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">InstanceType</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InstanceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">InstanceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraEquipmentInstance</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">NewEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">.</span><span class="n">AddDefaulted_GetRef</span><span class="p">();</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">EquipmentDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>
<span class="w">    </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OwnerComponent</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">(),</span><span class="w"> </span><span class="n">InstanceType</span><span class="p">);</span><span class="w">  </span><span class="c1">//@TODO: Using the actor instead of component as the outer due to UE-127172</span>
<span class="w">    </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewEntry</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">ASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbilitySystemComponent</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ULyraAbilitySet</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">AbilitySet</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">AbilitySetsToGrant</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">AbilitySet</span><span class="o">-&gt;</span><span class="n">GiveToAbilitySystem</span><span class="p">(</span><span class="n">ASC</span><span class="p">,</span><span class="w"> </span><span class="cm">/*inout*/</span><span class="w"> </span><span class="o">&amp;</span><span class="n">NewEntry</span><span class="p">.</span><span class="n">GrantedHandles</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//@TODO: Warning logging?</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Result</span><span class="o">-&gt;</span><span class="n">SpawnEquipmentActors</span><span class="p">(</span><span class="n">EquipmentCDO</span><span class="o">-&gt;</span><span class="n">ActorsToSpawn</span><span class="p">);</span>


<span class="w">    </span><span class="n">MarkItemDirty</span><span class="p">(</span><span class="n">NewEntry</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">FLyraEquipmentList::RemoveEntry</span><span class="p">(</span><span class="n">ULyraEquipmentInstance</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">EntryIt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Entries</span><span class="p">.</span><span class="n">CreateIterator</span><span class="p">();</span><span class="w"> </span><span class="n">EntryIt</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">EntryIt</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">EntryIt</span><span class="p">;</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Entry</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Instance</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">ASC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbilitySystemComponent</span><span class="p">())</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">Entry</span><span class="p">.</span><span class="n">GrantedHandles</span><span class="p">.</span><span class="n">TakeFromAbilitySystem</span><span class="p">(</span><span class="n">ASC</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">DestroyEquipmentActors</span><span class="p">();</span>


<span class="w">          </span><span class="n">EntryIt</span><span class="p">.</span><span class="n">RemoveCurrent</span><span class="p">();</span>
<span class="w">          </span><span class="n">MarkArrayDirty</span><span class="p">();</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   在FLyraAppliedEquipmentEntry中我们能够找到一个<strong>FLyraAbilitySet_GrantedHandles</strong>成员</p>
<div class="highlight"><pre><span></span><code><span class="cm">/** A single piece of applied equipment */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FLyraAppliedEquipmentEntry</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FFastArraySerializerItem</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="n">FLyraAppliedEquipmentEntry</span><span class="p">()</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">    </span><span class="n">FString</span><span class="w"> </span><span class="n">GetDebugString</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">FLyraEquipmentList</span><span class="p">;</span>
<span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="n">ULyraEquipmentManagerComponent</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// The equipment class that got equipped</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">ULyraEquipmentDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EquipmentDefinition</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">ULyraEquipmentInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Authority-only list of granted handles</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">NotReplicated</span><span class="p">)</span>
<span class="w">    </span><span class="n">FLyraAbilitySet_GrantedHandles</span><span class="w"> </span><span class="n">GrantedHandles</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   现在，我们就从InputConfig出发，一路前往了AbilitySet，窥探到了其作用机制，真是十分的有趣！</p>
<h2 id="part-iv-lyrainteraction">PART IV LyraInteraction</h2>
<p>​   Lyra的Interaction的逻辑可以分成两方面，一方面是被动的交互，例如从WeaponSpawner中拾取武器，这是通过碰撞调用OnOverlapBegin的逻辑实现的。这种交互比较简单，不太复杂。</p>
<p>​   另一方面是通过GAS来实现，这方面的交互使用了很多的接口来实现，我们慢慢研究一下。</p>
<h3 id="1-iinteractabletarget">1. IInteractableTarget</h3>
<p>​   Lyra中的交互逻辑的基础是接口类IInteractableTarget，实现了IInteractableTarget的Actor才能与Player产生交互。Lyra的Interaction的设计遵循了高度统一的一种思想，所有主动性的交互都是通过同一种实现思路，就是实现IInteractableTarget接口，而且IInteractableTarget子类各自的交互逻辑并非你写你的我写我的，而是有一套统一的逻辑，即通过<strong>GAS的支持</strong>来实现。</p>
<p>IInteractableTarget.h如下：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;CoreMinimal.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Abilities/GameplayAbility.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;InteractionOption.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;IInteractableTarget.generated.h&quot;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">FInteractionQuery</span><span class="p">;</span>

<span class="cm">/**  */</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FInteractionOptionBuilder</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">FInteractionOptionBuilder</span><span class="p">(</span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InterfaceTargetScope</span><span class="p">,</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">InteractOptions</span><span class="p">)</span>
<span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="n">Scope</span><span class="p">(</span><span class="n">InterfaceTargetScope</span><span class="p">)</span>
<span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="p">(</span><span class="n">InteractOptions</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">AddInteractionOption</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Option</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OptionEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Options</span><span class="p">.</span><span class="n">Add_GetRef</span><span class="p">(</span><span class="n">Option</span><span class="p">);</span>
<span class="w">       </span><span class="n">OptionEntry</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Scope</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Scope</span><span class="p">;</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">Options</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**  */</span>
<span class="n">UINTERFACE</span><span class="p">(</span><span class="n">MinimalAPI</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CannotImplementInterfaceInBlueprint</span><span class="p">))</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UInteractableTarget</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UInterface</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>
<span class="p">};</span>

<span class="cm">/**  */</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IInteractableTarget</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="cm">/**  */</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">GatherInteractionOptions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionQuery</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractQuery</span><span class="p">,</span><span class="w"> </span><span class="n">FInteractionOptionBuilder</span><span class="o">&amp;</span><span class="w"> </span><span class="n">OptionBuilder</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**  */</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">CustomizeInteractionEventData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayTag</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractionEventTag</span><span class="p">,</span><span class="w"> </span><span class="n">FGameplayEventData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InOutEventData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>​   乍一看这个接口并不太好理解，我们需要从其他地方入手。可以关注到IInteractableTarget提供了两个待覆写的函数，其中 GatherInteractionOptions中提出的InteractionOptions看起来是一个有趣的概念，我们试图从其入手了解Lyra的Interaction，但是我们注意到这个函数的参数中并没有一个InteractionOption，但是FInteractionOptionBuilder看起来是一个相关的东西，而它就定义在本头文件中。</p>
<h4 id="11-interactionoptionbuilder">1.1 InteractionOptionBuilder</h4>
<p>​   可以注意到，它只是一个纯C++类，没有UCLASS反射宏，可以推断出只是一个<strong>中介工具类</strong>。它维护了两个私有字段：</p>
<ul>
<li>TScriptInterface<IInteractableTarget> Scope</li>
<li>TArray<FInteractionOption>&amp; Options</li>
</ul>
<p>​   可见它担负着承载一系列FInteractionOption的作用，再看其函数AddInteractionOption，其将一个Option整合到了一个TArray<FInteractionOption>&amp; Options上，这是一个数组引用，可见其是用来填写外部的一个TArray<FInteractionOption>的。并且把Option中的OptionEntry.InteractableTarget赋值了自己的Scope，可见实际上这个Scope也只是用来帮助Option填入自己的来源的，因为一个InteractableTarget上的Option没法自己填写自己的来源也就是InteractableTarget自己。可见这个函数应该起到了读取某东西上的FInteractionOption，并为其设置一个InteractableTarget的作用。</p>
<p>​   在后面我们会看到，InteractionOptionBuilder就是一个纯纯的工具人，只是用来填写Option数组的。</p>
<p>​   接下来来看InteractionOption。</p>
<h4 id="12-interactionoption">1.2 InteractionOption</h4>
<p>InteractionOption.h</p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;CoreMinimal.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Abilities/GameplayAbility.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;InteractionOption.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">IInteractableTarget</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UUserWidget</span><span class="p">;</span>

<span class="cm">/**  */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FInteractionOption</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="cm">/** The interactable target */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractableTarget</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Simple text the interaction might return */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">FText</span><span class="w"> </span><span class="n">Text</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Simple sub-text the interaction might return */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">FText</span><span class="w"> </span><span class="n">SubText</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// METHODS OF INTERACTION</span>
<span class="w">    </span><span class="c1">//--------------------------------------------------------------</span>

<span class="w">    </span><span class="c1">// 1) Place an ability on the avatar that they can activate when they perform interaction.</span>

<span class="w">    </span><span class="cm">/** The ability to grant the avatar when they get near interactable objects. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSubclassOf</span><span class="o">&lt;</span><span class="n">UGameplayAbility</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractionAbilityToGrant</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// - OR -</span>

<span class="w">    </span><span class="c1">// 2) Allow the object we&#39;re interacting with to have its own ability system and interaction ability, that we can activate instead.</span>

<span class="w">    </span><span class="cm">/** The ability system on the target that can be used for the TargetInteractionHandle and sending the event, if needed. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UAbilitySystemComponent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TargetAbilitySystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** The ability spec to activate on the object for this option. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">TargetInteractionAbilityHandle</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// UI</span>
<span class="w">    </span><span class="c1">//--------------------------------------------------------------</span>

<span class="w">    </span><span class="cm">/** The widget to show for this kind of interaction. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSoftClassPtr</span><span class="o">&lt;</span><span class="n">UUserWidget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractionWidgetClass</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//--------------------------------------------------------------</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">FORCEINLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">InteractableTarget</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">InteractionAbilityToGrant</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">InteractionAbilityToGrant</span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">TargetAbilitySystem</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">TargetAbilitySystem</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">TargetInteractionAbilityHandle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">TargetInteractionAbilityHandle</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">InteractionWidgetClass</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">InteractionWidgetClass</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">Text</span><span class="p">.</span><span class="n">IdenticalTo</span><span class="p">(</span><span class="n">Other</span><span class="p">.</span><span class="n">Text</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="n">SubText</span><span class="p">.</span><span class="n">IdenticalTo</span><span class="p">(</span><span class="n">Other</span><span class="p">.</span><span class="n">SubText</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FORCEINLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">Other</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">FORCEINLINE</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">InteractableTarget</span><span class="p">.</span><span class="n">GetInterface</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Other</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="p">.</span><span class="n">GetInterface</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>​   InteractionOption是一个结构体，其中维护了比较多的字段，其中关注其带EditAnywhere的成员，它们属于这个Option自己，而其它的成员用于存储Option从外界获取的信息。</p>
<p>​   注意到其中最特别的一个字段：</p>
<p><img alt="image-20250203215057771" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203215057771.png" /></p>
<p>​   它表明了Lyra的交互思路是通过授予交互的主动方一个GameplayAbility来进行交互，所以一个InteractionOption就通过GA决定了一个可交互物的交互的内容。</p>
<p>​   我们查找InteractionOption的用法，可以发现只有LyraWorldCollectable中有维护FInteractionOption类型的成员：</p>
<p><img alt="image-20250203215750497" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203215750497.png" /></p>
<p>​   现在我们就了解了一个InteractableTarget的基础是什么了，就是需要继承IInteractableTarget接口的Actor首先要自己<strong>带有InteractionOption</strong>，然后通过某种方式将自己带有的InteractionOption中携带的用于交互的GameplayAbility<strong>授予交互的主体</strong>。而要做到这点，Lyra给出的做法是让实现了IInteractableTarget接口的Actor用自己实现的GatherInteractionOptions()函数，结合使用InteractionOptionBuilder去整合好一个Actor身上带有的InteractionOptions，然后统一授予给交互主体，这允许Lyra中的InteractableTarget可以携带<strong>多种“交互”</strong>，只不过Lyra中唯一实现的交互只有LyraWorldCollectable，而它身上只有一个InteractionOption。这也使得LyraWorldCollectable重写的GatherInteractionOptions()函数非常简单，就是把自己的Option填入传入的InteractionOptionBuilder。</p>
<h4 id="13-gameplayability_interact">1.3 GameplayAbility_Interact</h4>
<p>​   在关心每个可交互物各自携带的交互GameplayAbility各自实现了什么之前，我们首先应关心Lyra是如何把InteractableTarget身上的交互GameplayAbility授予给交互主体也就是Player的。</p>
<p>​   我们可以发现，InteractableTarget并没有提供一个交互窗口似的函数，也就是说，让Player获得其携带的交互GameplayAbility并不是InteractableTarget主动实现的，那是怎样的呢？</p>
<p>​   原来，Player会在ShooterExplore模式中初始化时被授予一个GameplayAbility_Interact（准确来说是GA_Interact，是其蓝图子类）在这个GA中，会进行一些主动检索InteractableTarget的逻辑，接下来让我们来看一看。</p>
<p>先上代码：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UIndicatorDescriptor</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UUserWidget</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayAbilityActorInfo</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayEventData</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ULyraGameplayAbility_Interact</span>
<span class="cm"> *</span>
<span class="cm"> * Gameplay ability used for character interacting</span>
<span class="cm"> */</span>
<span class="n">UCLASS</span><span class="p">(</span><span class="n">Abstract</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ULyraGameplayAbility_Interact</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ULyraGameplayAbility</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>

<span class="w">    </span><span class="n">ULyraGameplayAbility_Interact</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">::</span><span class="n">Get</span><span class="p">());</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ActivateAbility</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">Handle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilityActorInfo</span><span class="o">*</span><span class="w"> </span><span class="n">ActorInfo</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilityActivationInfo</span><span class="w"> </span><span class="n">ActivationInfo</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEventData</span><span class="o">*</span><span class="w"> </span><span class="n">TriggerEventData</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">UpdateInteractions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">InteractiveOptions</span><span class="p">);</span>

<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">TriggerInteraction</span><span class="p">();</span>

<span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CurrentOptions</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">()</span>
<span class="w">    </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TObjectPtr</span><span class="o">&lt;</span><span class="n">UIndicatorDescriptor</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Indicators</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1f</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span>

<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditDefaultsOnly</span><span class="p">)</span>
<span class="w">    </span><span class="n">TSoftClassPtr</span><span class="o">&lt;</span><span class="n">UUserWidget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">DefaultInteractionWidgetClass</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LyraGameplayAbility_Interact.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilitySystemComponent.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Interaction/IInteractableTarget.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Interaction/InteractionStatics.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Interaction/Tasks/AbilityTask_GrantNearbyInteraction.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NativeGameplayTags.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Player/LyraPlayerController.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;UI/IndicatorSystem/IndicatorDescriptor.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;UI/IndicatorSystem/LyraIndicatorManagerComponent.h&quot;</span>

<span class="cp">#include UE_INLINE_GENERATED_CPP_BY_NAME(LyraGameplayAbility_Interact)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UUserWidget</span><span class="p">;</span>

<span class="n">UE_DEFINE_GAMEPLAY_TAG_STATIC</span><span class="p">(</span><span class="n">TAG_Ability_Interaction_Activate</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ability.Interaction.Activate&quot;</span><span class="p">);</span>
<span class="n">UE_DEFINE_GAMEPLAY_TAG</span><span class="p">(</span><span class="n">TAG_INTERACTION_DURATION_MESSAGE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ability.Interaction.Duration.Message&quot;</span><span class="p">);</span>

<span class="n">ULyraGameplayAbility_Interact</span><span class="o">::</span><span class="n">ULyraGameplayAbility_Interact</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ActivationPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ELyraAbilityActivationPolicy</span><span class="o">::</span><span class="n">OnSpawn</span><span class="p">;</span>
<span class="w">    </span><span class="n">InstancingPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EGameplayAbilityInstancingPolicy</span><span class="o">::</span><span class="n">InstancedPerActor</span><span class="p">;</span>
<span class="w">    </span><span class="n">NetExecutionPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EGameplayAbilityNetExecutionPolicy</span><span class="o">::</span><span class="n">LocalPredicted</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraGameplayAbility_Interact</span><span class="o">::</span><span class="n">ActivateAbility</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">Handle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilityActorInfo</span><span class="o">*</span><span class="w"> </span><span class="n">ActorInfo</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayAbilityActivationInfo</span><span class="w"> </span><span class="n">ActivationInfo</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FGameplayEventData</span><span class="o">*</span><span class="w"> </span><span class="n">TriggerEventData</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">ActivateAbility</span><span class="p">(</span><span class="n">Handle</span><span class="p">,</span><span class="w"> </span><span class="n">ActorInfo</span><span class="p">,</span><span class="w"> </span><span class="n">ActivationInfo</span><span class="p">,</span><span class="w"> </span><span class="n">TriggerEventData</span><span class="p">);</span>

<span class="w">    </span><span class="n">UAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">AbilitySystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbilitySystemComponentFromActorInfo</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySystem</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">AbilitySystem</span><span class="o">-&gt;</span><span class="n">GetOwnerRole</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ROLE_Authority</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">*</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">GrantAbilitiesForNearbyInteractors</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="p">);</span>
<span class="w">       </span><span class="n">Task</span><span class="o">-&gt;</span><span class="n">ReadyForActivation</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraGameplayAbility_Interact</span><span class="o">::</span><span class="n">UpdateInteractions</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">InteractiveOptions</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ALyraPlayerController</span><span class="o">*</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetLyraPlayerControllerFromActorInfo</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ULyraIndicatorManagerComponent</span><span class="o">*</span><span class="w"> </span><span class="n">IndicatorManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ULyraIndicatorManagerComponent</span><span class="o">::</span><span class="n">GetComponent</span><span class="p">(</span><span class="n">PC</span><span class="p">))</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">UIndicatorDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">Indicator</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Indicators</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">IndicatorManager</span><span class="o">-&gt;</span><span class="n">RemoveIndicator</span><span class="p">(</span><span class="n">Indicator</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="n">Indicators</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractionOption</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InteractiveOptions</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">InteractableTargetActor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UInteractionStatics</span><span class="o">::</span><span class="n">GetActorFromInteractableTarget</span><span class="p">(</span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="p">);</span>

<span class="w">             </span><span class="n">TSoftClassPtr</span><span class="o">&lt;</span><span class="n">UUserWidget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractionWidgetClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">InteractionWidgetClass</span><span class="p">.</span><span class="n">IsNull</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">DefaultInteractionWidgetClass</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">InteractionWidgetClass</span><span class="p">;</span>

<span class="w">             </span><span class="n">UIndicatorDescriptor</span><span class="o">*</span><span class="w"> </span><span class="n">Indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewObject</span><span class="o">&lt;</span><span class="n">UIndicatorDescriptor</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">             </span><span class="n">Indicator</span><span class="o">-&gt;</span><span class="n">SetDataObject</span><span class="p">(</span><span class="n">InteractableTargetActor</span><span class="p">);</span>
<span class="w">             </span><span class="n">Indicator</span><span class="o">-&gt;</span><span class="n">SetSceneComponent</span><span class="p">(</span><span class="n">InteractableTargetActor</span><span class="o">-&gt;</span><span class="n">GetRootComponent</span><span class="p">());</span>
<span class="w">             </span><span class="n">Indicator</span><span class="o">-&gt;</span><span class="n">SetIndicatorClass</span><span class="p">(</span><span class="n">InteractionWidgetClass</span><span class="p">);</span>
<span class="w">             </span><span class="n">IndicatorManager</span><span class="o">-&gt;</span><span class="n">AddIndicator</span><span class="p">(</span><span class="n">Indicator</span><span class="p">);</span>

<span class="w">             </span><span class="n">Indicators</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Indicator</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">       </span><span class="k">else</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="c1">//TODO This should probably be a noisy warning.  Why are we updating interactions on a PC that can never do anything with them?</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">CurrentOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InteractiveOptions</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">ULyraGameplayAbility_Interact</span><span class="o">::</span><span class="n">TriggerInteraction</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentOptions</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">UAbilitySystemComponent</span><span class="o">*</span><span class="w"> </span><span class="n">AbilitySystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAbilitySystemComponentFromActorInfo</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AbilitySystem</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">InteractionOption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">       </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">Instigator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAvatarActorFromActorInfo</span><span class="p">();</span>
<span class="w">       </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">InteractableTargetActor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UInteractionStatics</span><span class="o">::</span><span class="n">GetActorFromInteractableTarget</span><span class="p">(</span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="p">);</span>

<span class="w">       </span><span class="c1">// Allow the target to customize the event data we&#39;re about to pass in, in case the ability needs custom data</span>
<span class="w">       </span><span class="c1">// that only the actor knows.</span>
<span class="w">       </span><span class="n">FGameplayEventData</span><span class="w"> </span><span class="n">Payload</span><span class="p">;</span>
<span class="w">       </span><span class="n">Payload</span><span class="p">.</span><span class="n">EventTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAG_Ability_Interaction_Activate</span><span class="p">;</span>
<span class="w">       </span><span class="n">Payload</span><span class="p">.</span><span class="n">Instigator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instigator</span><span class="p">;</span>
<span class="w">       </span><span class="n">Payload</span><span class="p">.</span><span class="n">Target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InteractableTargetActor</span><span class="p">;</span>

<span class="w">       </span><span class="c1">// If needed we allow the interactable target to manipulate the event data so that for example, a button on the wall</span>
<span class="w">       </span><span class="c1">// may want to specify a door actor to execute the ability on, so it might choose to override Target to be the</span>
<span class="w">       </span><span class="c1">// door actor.</span>
<span class="w">       </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">InteractableTarget</span><span class="o">-&gt;</span><span class="n">CustomizeInteractionEventData</span><span class="p">(</span><span class="n">TAG_Ability_Interaction_Activate</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p">);</span>

<span class="w">       </span><span class="c1">// Grab the target actor off the payload we&#39;re going to use it as the &#39;avatar&#39; for the interaction, and the</span>
<span class="w">       </span><span class="c1">// source InteractableTarget actor as the owner actor.</span>
<span class="w">       </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">TargetActor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">AActor</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ToRawPtr</span><span class="p">(</span><span class="n">Payload</span><span class="p">.</span><span class="n">Target</span><span class="p">));</span>

<span class="w">       </span><span class="c1">// The actor info needed for the interaction.</span>
<span class="w">       </span><span class="n">FGameplayAbilityActorInfo</span><span class="w"> </span><span class="n">ActorInfo</span><span class="p">;</span>
<span class="w">       </span><span class="n">ActorInfo</span><span class="p">.</span><span class="n">InitFromActor</span><span class="p">(</span><span class="n">InteractableTargetActor</span><span class="p">,</span><span class="w"> </span><span class="n">TargetActor</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">TargetAbilitySystem</span><span class="p">);</span>

<span class="w">       </span><span class="c1">// Trigger the ability using event tag.</span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">bSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">TargetAbilitySystem</span><span class="o">-&gt;</span><span class="n">TriggerAbilityFromGameplayEvent</span><span class="p">(</span>
<span class="w">          </span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">TargetInteractionAbilityHandle</span><span class="p">,</span>
<span class="w">          </span><span class="o">&amp;</span><span class="n">ActorInfo</span><span class="p">,</span>
<span class="w">          </span><span class="n">TAG_Ability_Interaction_Activate</span><span class="p">,</span>
<span class="w">          </span><span class="o">&amp;</span><span class="n">Payload</span><span class="p">,</span>
<span class="w">          </span><span class="o">*</span><span class="n">InteractionOption</span><span class="p">.</span><span class="n">TargetAbilitySystem</span>
<span class="w">       </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="abilitytask_grantnearbyinteraction">AbilityTask_GrantNearbyInteraction</h5>
<p>​   首先我们啥也不看，就只关注这个GA的ActivateAbility的部分，这个GA基类的ActivateAbility中只是准备了一个AbilityTask_GrantNearbyInteraction，这个AbilityTask的命名有点迷惑性，看似是向外给出Ability，实际上是把外部的Ability传给正在激活GA_Interact的Player。</p>
<p>代码：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Abilities/Tasks/AbilityTask.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;AbilityTask_GrantNearbyInteraction.generated.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UGameplayAbility</span><span class="p">;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UObject</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FFrame</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FGameplayAbilitySpecHandle</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FObjectKey</span><span class="p">;</span>

<span class="n">UCLASS</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UAbilityTask_GrantNearbyInteraction</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UAbilityTask</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_UCLASS_BODY</span><span class="p">()</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Activate</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Wait until an overlap occurs. This will need to be better fleshed out so we can specify game specific collision requirements */</span>
<span class="w">    </span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">,</span><span class="w"> </span><span class="n">Category</span><span class="o">=</span><span class="s">&quot;Ability|Tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HidePin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OwningAbility&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DefaultToSelf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;OwningAbility&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BlueprintInternalUseOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;TRUE&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">*</span><span class="w"> </span><span class="n">GrantAbilitiesForNearbyInteractors</span><span class="p">(</span><span class="n">UGameplayAbility</span><span class="o">*</span><span class="w"> </span><span class="n">OwningAbility</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">OnDestroy</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">AbilityEnded</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">QueryInteractables</span><span class="p">();</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.100</span><span class="p">;</span>

<span class="w">    </span><span class="n">FTimerHandle</span><span class="w"> </span><span class="n">QueryTimerHandle</span><span class="p">;</span>

<span class="w">    </span><span class="n">TMap</span><span class="o">&lt;</span><span class="n">FObjectKey</span><span class="p">,</span><span class="w"> </span><span class="n">FGameplayAbilitySpecHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractionAbilityCache</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FObjectInitializer</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Super</span><span class="p">(</span><span class="n">ObjectInitializer</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">*</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">GrantAbilitiesForNearbyInteractors</span><span class="p">(</span><span class="n">UGameplayAbility</span><span class="o">*</span><span class="w"> </span><span class="n">OwningAbility</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">*</span><span class="w"> </span><span class="n">MyObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewAbilityTask</span><span class="o">&lt;</span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OwningAbility</span><span class="p">);</span>
<span class="w">    </span><span class="n">MyObj</span><span class="o">-&gt;</span><span class="n">InteractionScanRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InteractionScanRange</span><span class="p">;</span>
<span class="w">    </span><span class="n">MyObj</span><span class="o">-&gt;</span><span class="n">InteractionScanRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">MyObj</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">Activate</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SetWaitingOnAvatar</span><span class="p">();</span>

<span class="w">    </span><span class="n">UWorld</span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">();</span>
<span class="w">    </span><span class="n">World</span><span class="o">-&gt;</span><span class="n">GetTimerManager</span><span class="p">().</span><span class="n">SetTimer</span><span class="p">(</span><span class="n">QueryTimerHandle</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">QueryInteractables</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionScanRate</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">OnDestroy</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">AbilityEnded</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UWorld</span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">World</span><span class="o">-&gt;</span><span class="n">GetTimerManager</span><span class="p">().</span><span class="n">ClearTimer</span><span class="p">(</span><span class="n">QueryTimerHandle</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Super</span><span class="o">::</span><span class="n">OnDestroy</span><span class="p">(</span><span class="n">AbilityEnded</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="o">::</span><span class="n">QueryInteractables</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">UWorld</span><span class="o">*</span><span class="w"> </span><span class="n">World</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetWorld</span><span class="p">();</span>
<span class="w">    </span><span class="n">AActor</span><span class="o">*</span><span class="w"> </span><span class="n">ActorOwner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetAvatarActor</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">World</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ActorOwner</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">FCollisionQueryParams</span><span class="w"> </span><span class="nf">Params</span><span class="p">(</span><span class="n">SCENE_QUERY_STAT</span><span class="p">(</span><span class="n">UAbilityTask_GrantNearbyInteraction</span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">       </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOverlapResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OverlapResults</span><span class="p">;</span>
<span class="w">       </span><span class="n">World</span><span class="o">-&gt;</span><span class="n">OverlapMultiByChannel</span><span class="p">(</span><span class="n">OUT</span><span class="w"> </span><span class="n">OverlapResults</span><span class="p">,</span><span class="w"> </span><span class="n">ActorOwner</span><span class="o">-&gt;</span><span class="n">GetActorLocation</span><span class="p">(),</span><span class="w"> </span><span class="n">FQuat</span><span class="o">::</span><span class="n">Identity</span><span class="p">,</span><span class="w"> </span><span class="n">Lyra_TraceChannel_Interaction</span><span class="p">,</span><span class="w"> </span><span class="n">FCollisionShape</span><span class="o">::</span><span class="n">MakeSphere</span><span class="p">(</span><span class="n">InteractionScanRange</span><span class="p">),</span><span class="w"> </span><span class="n">Params</span><span class="p">);</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OverlapResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">InteractableTargets</span><span class="p">;</span>
<span class="w">          </span><span class="n">UInteractionStatics</span><span class="o">::</span><span class="n">AppendInteractableTargetsFromOverlapResults</span><span class="p">(</span><span class="n">OverlapResults</span><span class="p">,</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="n">InteractableTargets</span><span class="p">);</span>

<span class="w">          </span><span class="n">FInteractionQuery</span><span class="w"> </span><span class="n">InteractionQuery</span><span class="p">;</span>
<span class="w">          </span><span class="n">InteractionQuery</span><span class="p">.</span><span class="n">RequestingAvatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActorOwner</span><span class="p">;</span>
<span class="w">          </span><span class="n">InteractionQuery</span><span class="p">.</span><span class="n">RequestingController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cast</span><span class="o">&lt;</span><span class="n">AController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ActorOwner</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">());</span>

<span class="w">          </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FInteractionOption</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Options</span><span class="p">;</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">InteractiveTarget</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InteractableTargets</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="n">FInteractionOptionBuilder</span><span class="w"> </span><span class="nf">InteractionBuilder</span><span class="p">(</span><span class="n">InteractiveTarget</span><span class="p">,</span><span class="w"> </span><span class="n">Options</span><span class="p">);</span>
<span class="w">             </span><span class="n">InteractiveTarget</span><span class="o">-&gt;</span><span class="n">GatherInteractionOptions</span><span class="p">(</span><span class="n">InteractionQuery</span><span class="p">,</span><span class="w"> </span><span class="n">InteractionBuilder</span><span class="p">);</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="c1">// Check if any of the options need to grant the ability to the user before they can be used.</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">FInteractionOption</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Option</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Options</span><span class="p">)</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Option</span><span class="p">.</span><span class="n">InteractionAbilityToGrant</span><span class="p">)</span>
<span class="w">             </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Grant the ability to the GAS, otherwise it won&#39;t be able to do whatever the interaction is.</span>
<span class="w">                </span><span class="n">FObjectKey</span><span class="w"> </span><span class="nf">ObjectKey</span><span class="p">(</span><span class="n">Option</span><span class="p">.</span><span class="n">InteractionAbilityToGrant</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">InteractionAbilityCache</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">ObjectKey</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                   </span><span class="n">FGameplayAbilitySpec</span><span class="w"> </span><span class="nf">Spec</span><span class="p">(</span><span class="n">Option</span><span class="p">.</span><span class="n">InteractionAbilityToGrant</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">INDEX_NONE</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="w">                   </span><span class="n">FGameplayAbilitySpecHandle</span><span class="w"> </span><span class="n">Handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AbilitySystemComponent</span><span class="o">-&gt;</span><span class="n">GiveAbility</span><span class="p">(</span><span class="n">Spec</span><span class="p">);</span>
<span class="w">                   </span><span class="n">InteractionAbilityCache</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ObjectKey</span><span class="p">,</span><span class="w"> </span><span class="n">Handle</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">             </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   先看其Activate中进行的事情，其在Activate中非常简单地设置了一个Timer用于按照给定的InteractionScanRate为周期，激活自己的一个内部函数QueryInteractables()，在这个函数中，先通过OverlapMultiByChannel去收集以Player的坐标为中心，给定检测半径InteractionScanRange的球体中的所有的启用了Lyra_TraceChannel_Interaction的Overlap的<strong>“对象”</strong>（之所以说对象是因为在后文我们可以看到Lyra的“交互”既可以涉及Actor，还可以涉及Component），可以在B_InteractableRock中发现它的StaticMesh设置了这个碰撞通道的Overlap：</p>
<p><img alt="image-20250203225153728" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203225153728.png" /></p>
<p>​   然后通过Interaction相关的静态函数UInteractionStatics::AppendInteractableTargetsFromOverlapResults()去<strong>挑出</strong>Overlap结果数组中的实现了IInteractableTarget的Actor或Component。是的，Lyra设计的交互情形<strong>不仅仅局限于Actor</strong>，它还设计了可以让Component实现IInteractableTarget接口从而参与交互。</p>
<p>静态函数实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">UInteractionStatics::AppendInteractableTargetsFromOverlapResults</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOverlapResult</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">OverlapResults</span><span class="p">,</span><span class="w"> </span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;&gt;&amp;</span><span class="w"> </span><span class="n">OutInteractableTargets</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FOverlapResult</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Overlap</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">OverlapResults</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractableActor</span><span class="p">(</span><span class="n">Overlap</span><span class="p">.</span><span class="n">GetActor</span><span class="p">());</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InteractableActor</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutInteractableTargets</span><span class="p">.</span><span class="n">AddUnique</span><span class="p">(</span><span class="n">InteractableActor</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>

<span class="w">       </span><span class="n">TScriptInterface</span><span class="o">&lt;</span><span class="n">IInteractableTarget</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InteractableComponent</span><span class="p">(</span><span class="n">Overlap</span><span class="p">.</span><span class="n">GetComponent</span><span class="p">());</span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">InteractableComponent</span><span class="p">)</span>
<span class="w">       </span><span class="p">{</span>
<span class="w">          </span><span class="n">OutInteractableTargets</span><span class="p">.</span><span class="n">AddUnique</span><span class="p">(</span><span class="n">InteractableComponent</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>​   然后，挑出IInteractableTarget之后，就会把所有IInteractableTarget中的InteractionOptions通过其各自实现的GatherInteractionOptions()装载入一个InteractionOptionBuilder中，以此就获取到了检测半径内的InteractionOptions，实际上GatherInteractionOptions()还有一个参数，只不过在Lyra实现出来的交互内容中不需要这个东西：</p>
<p><img alt="image-20250203232033419" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203232033419.png" /></p>
<p>FInteractionQuery的定义：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;CoreMinimal.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Abilities/GameplayAbility.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;InteractionQuery.generated.h&quot;</span>


<span class="cm">/**  */</span>
<span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FInteractionQuery</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GENERATED_BODY</span><span class="p">()</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="cm">/** The requesting pawn. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TWeakObjectPtr</span><span class="o">&lt;</span><span class="n">AActor</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RequestingAvatar</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Allow us to specify a controller - does not need to match the owner of the requesting avatar. */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TWeakObjectPtr</span><span class="o">&lt;</span><span class="n">AController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RequestingController</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** A generic UObject to shove in extra data required for the interaction */</span>
<span class="w">    </span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">BlueprintReadWrite</span><span class="p">)</span>
<span class="w">    </span><span class="n">TWeakObjectPtr</span><span class="o">&lt;</span><span class="n">UObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">OptionalObjectData</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>​   InteractionQuery应该是提供了一种是否允许交互的查询，例如在某些游戏中，只允许某个阵营或某些玩家去和自己的设施交互这样的机制，或者不允许NPC去获得Player才允许进行的某些交互这，这就没必要让它们拿到这个InteractionOption了（这些或许可以通过检测一些Tag之类的）。</p>
<p>​   最后一步，AbilityTask_GrantNearbyInteraction做的就是去检查自己得到的Options中是否有需要的添加给交互主体的GA，这个Task会缓存一个Map来记录已经授予给交互主体的GASpecHandle，通过检查是否已经存有该Handle来避免重复添加GA。</p>
<p><img alt="image-20250203233003891" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203233003891.png" /></p>
<p><img alt="image-20250203233027878" src="C:/Users/Max1122Chen/AppData/Roaming/Typora/typora-user-images/image-20250203233027878.png" /></p>
<p>​   所以，这个AbilityTask其实就是在做一件事情：周期性地检索交互主体周围的IInteractableTarget，把它们带有的起到实现交互的GA授予给交互主体。但是实际上这个AbilityTask并没有被Lyra的GA_Interact用到，因为这个Task在LyraGameplayAbility_Interact基类的Activate中调用，而实际上在Lyra的GA_Interact的Activate中并没有调用父类的Activate，所以算是没有用到，GA_Interact转而使用了另一个AbilityTask——UAbilityTask_WaitForInteractableTargets_SingleLineTrace，这个AbilityTask继承自UAbilityTask_WaitForInteractableTargets。</p>
<p>​   WaitForInteractableTargets_SingleLineTrace就并非采用周期性地作球体检测的一个大包围的交互逻辑了，而是采用周期性地进行射线检测。</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "navigation.instant", "search.hightlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>