# 虚幻游戏存档方式

### 使用蓝图类——SaveGame

​	SaveGame是一个用于保存数据的类，我们可以增加变量来为我们加载和保存时提高支持。

​	设置这些变量时，需要先考虑哪些数据是需要保存的。

​	可以使用结构体来保存数据使得他们更容易管理，在内容浏览器中添加Struct。

​	例如我们可以保存玩家的变换、生命等，如果想要保存玩家的朝向，保存Transform是不够的，Transform保存的朝向是模型的朝向，需要摄像机的朝向。

​	完成结构体的合适设置后，在SaveGame中创建该结构体类型变量。

​	想要记录关卡中物体的变换的话，可以在SaveGame中创建一个transform类型的数组



### 保存与加载

运用SaveGametoSlot函数与LoadGamefromSlot函数，Slot就像存档位，你可以选择不同的存档。

SaveGametoSlot函数接受一个SaveGame，把它存到某个名字的Slot内。

LoadGamefromSlot函数接受一个SlotName，返回其对应的SaveGame。

AsyncSaveGametoSlot函数与AsyncLoadGamefromSlot函数（异步保存加载）

异步保存加载可以让这两件事在后台进行，如果你有大量数据需要保存加载又不希望打断游戏时，这会很有用。

p.s.通常采用同步加载，异步保存的做法。



### 合适的保存加载的实现

​	虚幻引擎启用时，会先创建一个UGameInstance，它是一个处理游戏状态的对象，超脱于关卡存在，玩家移动到不同的关卡时，它并不会改变，所有我们可以用GameInstance来进行保存加载。

​	我们需要创建一个自定义的GameInstance，**并把它在ProjectSettings中应用成游戏使用的GameInstance**。

​	GameInstance中的Event Init会在它被创建时调用，在Game Instance中创建一个对SaveGame的引用变量，在其中实现保存加载。

​	而我们需要为GameInstance定义一个**接口类**，来方便外部使用GameInstance的保存加载功能，通过参数，可以选择不同的具体实现方式。我们需要GetGameData，SaveGameData，LoadGameData三个接口函数，为后两者添加布尔参数选择同步或异步。

LoadGameData：先判断是否有存档，如果没有，新增Save Game，如有，直接读取。

<img src="C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128150702670.png" alt="image-20241128150702670" style="zoom:150%;" />

![image-20241128150943047](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128150943047.png)

由于异步读取是异步的，需要广播完成读取事件以通知有关的类

SaveGameData：

![image-20241128151642312](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128151642312.png)



接下来创建一个“检查点”Actor用于测试，它只负责告知保存时机，不负责处理保存数据的逻辑

checkpoint 的逻辑

![image-20241128154540771](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128154540771.png)

PlayerCharacter的GetPlayerSave函数：

![image-20241128154635750](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128154635750.png)

做完上面这些，我们只是存储了游戏数据，我们拿到了一份游戏存档，但我们还需要把它们应用到对应的actor上，不然什么都不会发生。千万不要忘记检查有没有应用正确的GameInstance

![image-20241128155844562](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128155844562.png)

在BP_PlayerCharacter的Beginplay中调用这个函数

![image-20241128160245965](C:\Users\Max1122Chen\AppData\Roaming\Typora\typora-user-images\image-20241128160245965.png)

做完这些以后就大功告成了！！！

#### 从默认状态开始

在工程文件的Save文件夹下有SaveGames文件夹，内部存储的就是我们创建的GameSave

